---
title: 微信 JSSDK 调用实例
date: 2017-05-03 14:34:39
updated: 2017-05-03 14:34:39
categories: Node.js
---

有时我们需要在网页中调用微信的一些功能，例如，打开摄像头扫描，分享好友的微信功能，这时就需要在网页中调用 `jssdk`,但是这需要一个认证过程，本文主要就会是对微信公众号网页开发中调用 `jssdk` 备忘，后台语言 `nodejs`。


### 一、JS 接口安全域名填写

登入公众号后台管理系统 -> 公众号设置 -> 功能设置，设置 **JS接口安全域名设置**。这里需要注意的是，域名必须是 **一级域名**，且只能是域名部分，例如: `jessechiu.com`,不能包含有 `http://` 等其它部分。
ps: 回测验证可以支持二级域名: `test.jessechiu.com`


### 二、后端代码部分

```js

// nodejs 部分
// 获取 config 签名认证信息入口
router.all('/jssdk-config',(req,res,next)=>{
	console.log('req.body.url: ' \+ req.body.url);
	tools.getJsConfig({
		debug: false,
		jsApiList: ['scanQRCode', 'chooseImage'],
		url: req.body.url
	})
	.then((result) => {
		res.send(result)
	})
	.catch(() => {});
});


// 需要调用 jssdk 函数的页面入口
router.get('/jssdk-demo', (req, res, next) => {
	res.render('jssdk-demo', {});
});
```

### 三、网页部分代码

```html
<!DOCTYPE HTML>
<html>

<head>
    <title>绑定手机号</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <link rel="stylesheet" href="/static/stylesheets/style.css">
    <script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
</head>

<body>
    <button id="scan">调用扫描</button>
    <button id="uploadImg">上传图片</button>
    <script type="text/javascript">
    window.onload = function() {

        $.ajax({
            url: 'http://jessechiu.com/jssdk-config/', // 请求签名认证数据地址
            type: 'POST',
            data: {
                'cmd': 'get_js_config',
                'url': 'http://jessechiu.com/jssdk-demo/' // 这里的地址需要更换为你要使用 jssk api 的网页地址，也就是本文件的网址
            }, // 需要调用 jssdk 的地址，也就是本网页地址
            datatype: 'json',
            success: function(data) {
                handleJsConfig(data);
            }
        });

        function handleJsConfig(data) {
            console.log('handleJsConfig(): '\ + JSON.stringify(data));
            // 从后台得到签名认证信息，进行认证
            wx.config(data);
            // 认证出错时调用
            wx.error(function(res) {
                console.log('wx.error(): '\ + JSON.stringify(res));
                // alert('wx.error: ' \+ JSON.stringify(res));
            });

            // 认证结束时调用，所以调用 sdk 中的函数需要写在此回调函数中
            wx.ready(function() {
                console.log('wx.ready()');
                wx.checkJsApi({
                    jsApiList: ['scanQRCode', 'chooseImage'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
                    success: function(res) {
                        console.log('success: '\ + JSON.stringify(res));
                        // alert(JSON.stringify(res));
                    },
                    fail: function(err) {
                        // alert('fail: ' \+ JSON.stringify(err));
                        console.log('fail: '\ + JSON.stringify(err));
                    }
                });

                let scanBtn = document.getElementById('scan');
                let uploadImgBtn = document.getElementById('uploadImg');
                scanBtn.addEventListener('click', function() {
                    wx.scanQRCode({
                        needResult: 0, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                        scanType: ["qrCode", "barCode"], // 可以指定扫二维码还是一维码，默认二者都有
                        success: function(res) {
                            var result = res.resultStr; // 当ne
                            edResult 为 1 时， 扫码返回的结果
                            console.log('success: '\ + JSON.stringify(res));
                            // alert('success: ' \+ JSON.stringify(res));
                        },
                        fail: function(err) {
                            // alert('fail: ' \+ JSON.stringify(err));
                            console.log('fail: '\ + JSON.stringify(err));
                        }
                    });
                });
                uploadImgBtn.addEventListener('click', function() {
                    wx.chooseImage({
                        count: 1, // 默认9
                        sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                        sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                        success: function(res) {
                            var localIds = res.localIds; //返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                            console.log('success: '\ + JSON.stringify(res));
                            // alert('success: ' \+ JSON.stringify(res));
                        },
                        fail: function(err) {
                            // alert('fail: ' \+ JSON.stringify(err));
                            console.log('fail: '\ + JSON.stringify(err));
                        }
                    });
                });
            });
        }
    }
    </script>
</body>
</html>

```
### 参考
- [微信JS-SDK说明文档](https://mp.weixin.qq.com/wiki/7/aaa137b55fb2e0456bf8dd9148dd613f.html)
- [nodejs jssdk 调用参考实例](http://blog.csdn.net/sinat_29843547/article/details/49357193)

  


  


  


  

