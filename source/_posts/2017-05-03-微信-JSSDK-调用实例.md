---
title: 微信 JSSDK 调用实例
date: 2017-05-03 14:34:39
updated: 2017-05-03 14:34:39
categories: WeChat
---

有时我们需要在网页中调用微信的一些功能，例如，打开摄像头扫描，分享好友的微信功能，这时就需要在网页中调用 `jssdk`,但是这需要一个认证过程，本文主要就会是对微信公众号网页开发中调用 `jssdk` 备忘，后台语言 `nodejs`。


## 一、JS 接口安全域名填写

登入公众号后台管理系统 -> 公众号设置 -> 功能设置，设置 **JS接口安全域名设置**。这里需要注意的是，域名必须是 **一级域名**，且只能是域名部分，例如: `jessechiu.com`,不能包含有 `http://` 等其它部分。
ps: 回测验证可以支持二级域名: `test.jessechiu.com`


## 二、后端代码部分

```js

// nodejs 部分
// 获取 config 签名认证信息入口
router.all('/jssdk-config',(req,res,next)=>{
	console.log('req.body.url: ' \+ req.body.url);
	tools.getJsConfig({
		debug: false,
		jsApiList: ['scanQRCode', 'chooseImage'],
		url: req.body.url
	})
	.then((result) => {
		res.send(result)
	})
	.catch(() => {});
});


// 需要调用 jssdk 函数的页面入口
router.get('/jssdk-demo', (req, res, next) => {
	res.render('jssdk-demo', {});
});
```

## 三、网页部分代码

```html
<!DOCTYPE HTML>
<html>

<head>
    <title>绑定手机号</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <link rel="stylesheet" href="/static/stylesheets/style.css">
    <script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
</head>

<body>
    <button id="scan">调用扫描</button>
    <button id="uploadImg">上传图片</button>
    <script type="text/javascript">
    window.onload = function() {

        $.ajax({
            url: 'http://jessechiu.com/jssdk-config/', // 请求签名认证数据地址
            type: 'POST',
            data: {
                'cmd': 'get_js_config',
                'url': 'http://jessechiu.com/jssdk-demo/' // 这里的地址需要更换为你要使用 jssk api 的网页地址，也就是本文件的网址
            }, // 需要调用 jssdk 的地址，也就是本网页地址
            datatype: 'json',
            success: function(data) {
                handleJsConfig(data);
            }
        });

        function handleJsConfig(data) {
            console.log('handleJsConfig(): '\ + JSON.stringify(data));
            // 从后台得到签名认证信息，进行认证
            wx.config(data);
            // 认证出错时调用
            wx.error(function(res) {
                console.log('wx.error(): '\ + JSON.stringify(res));
                // alert('wx.error: ' \+ JSON.stringify(res));
            });

            // 认证结束时调用，所以调用 sdk 中的函数需要写在此回调函数中
            wx.ready(function() {
                console.log('wx.ready()');
                wx.checkJsApi({
                    jsApiList: ['scanQRCode', 'chooseImage'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
                    success: function(res) {
                        console.log('success: '\ + JSON.stringify(res));
                        // alert(JSON.stringify(res));
                    },
                    fail: function(err) {
                        // alert('fail: ' \+ JSON.stringify(err));
                        console.log('fail: '\ + JSON.stringify(err));
                    }
                });

                let scanBtn = document.getElementById('scan');
                let uploadImgBtn = document.getElementById('uploadImg');
                scanBtn.addEventListener('click', function() {
                    wx.scanQRCode({
                        needResult: 0, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
                        scanType: ["qrCode", "barCode"], // 可以指定扫二维码还是一维码，默认二者都有
                        success: function(res) {
                            var result = res.resultStr; // 当ne
                            edResult 为 1 时， 扫码返回的结果
                            console.log('success: '\ + JSON.stringify(res));
                            // alert('success: ' \+ JSON.stringify(res));
                        },
                        fail: function(err) {
                            // alert('fail: ' \+ JSON.stringify(err));
                            console.log('fail: '\ + JSON.stringify(err));
                        }
                    });
                });
                uploadImgBtn.addEventListener('click', function() {
                    wx.chooseImage({
                        count: 1, // 默认9
                        sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                        sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                        success: function(res) {
                            var localIds = res.localIds; //返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                            console.log('success: '\ + JSON.stringify(res));
                            // alert('success: ' \+ JSON.stringify(res));
                        },
                        fail: function(err) {
                            // alert('fail: ' \+ JSON.stringify(err));
                            console.log('fail: '\ + JSON.stringify(err));
                        }
                    });
                });
            });
        }
    }
    </script>
</body>
</html>

```

## 四、错误排查
### 1. `config:invalid signature`
如果是invalid signature签名错误。建议按如下顺序检查：
1.确认签名算法正确，可用 `http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign` 页面工具进行校验。
2.确认 `config` 中 `nonceStr（js中驼峰标准大写S）`, `timestamp` 与用以签名中的对应 `noncestr`, `timestamp` 一致。
3.确认 `url` 是页面完整的 `url(请在当前页面 alert(location.href.split('#')[0])` 确认，包括 `http(s)://` 部分，以及 `?` 后面的 `GET` 参数部分,但不包括 `#hash`后面的部分。
4.确认 `config` 中的 `appid` 与用来获取 `jsapi_ticket` 的 `appid` 一致。
5.确保一定缓存 `access_token` 和 `jsapi_ticket`

### 2. 分享给朋友接口没反应
```js
function shareMessage(){
  wx.onMenuShareAppMessage({
      title: '', // 分享标题
      desc: '', // 分享描述
      link: '', // 分享链接，该链接域名必须与当前企业的可信域名一致
      imgUrl: '', // 分享图标
      type: '', // 分享类型,music、video或link，不填默认为link
      dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
      success: function () {
          // 用户确认分享后执行的回调函数
      },
      cancel: function () {
          // 用户取消分享后执行的回调函数
      }
  });
}
```
jssdk 的认证都 ok，但是点击调用上面的的函数界面就是没有反应。如果你也碰到这个问题，说明没理解该 API 的用处，也算是个坑吧。
正确的理解应该是: `分享给朋友 接口不是指直接能够分享朋友圈，而是指它会改变右上角菜单里的分享内容`; [参考](http://qydev.weixin.qq.com/qa/index.php?qa=6428&qa_1=%E6%8E%A5%E5%8F%A3%EF%BC%8C%E6%B2%A1%E6%9C%89%E4%BB%BB%E4%BD%95%E5%8F%8D%E5%BA%94%EF%BC%8C%E4%BD%BF%E7%94%A8checkjsapi%E6%A3%80%E6%B5%8B%E6%8E%A5%E5%8F%A3%EF%BC%8C%E8%BF%94%E5%9B%9Etrue&show=6428#q6428)


## 参考
- [微信JS-SDK说明文档](https://mp.weixin.qq.com/wiki/7/aaa137b55fb2e0456bf8dd9148dd613f.html)
- [nodejs jssdk 调用参考实例](http://blog.csdn.net/sinat_29843547/article/details/49357193)
- [微信config:invalid signature这个错误的解决办法](http://www.thinkphp.cn/code/1568.html)

  


  


  


  

