---
title: Jsonp 实现原理
date: 2016-10-17 11:07:00
updated: 2016-10-17 11:07:00
tags:
categories: BackEnd
feature:
---

![JSNOP](http://od6sd4xau.bkt.clouddn.com/JSONP.png)

### 一、什么是 JSONP？

JSONP 是服务器与客户端跨源通信的常用方法。最大特点就是简单适用，**老式浏览器全部支持**，服务器改造非常小。

### 二、实现原理

它的基本思想是，网页通过添加一个 `<script>` 元素，向服务器请求 `JSON` 数据，这种做法不受同源政策限制；服务器收到请求后，将数据放在一个 **指定名字的回调函数里** 传回来。

首先，网页动态插入 `<script>` 元素，由它向跨源网址发出请求。

```javascript
function addScriptTag(src) {
  var script = document.createElement('script');
  script.setAttribute("type","text/javascript");
  script.src = src;
  document.body.appendChild(script);
}

window.onload = function () {
  addScriptTag('http://example.com/ip?callback=foo');
}

function foo(data) {
  console.log('Your public IP address is: ' + data.ip);
};
```

上面代码通过动态添加 `<script>`，向服务器 `example.com` 发出请求。注意，该请求的查询字符串有一个`callback` 参数，用来指定回调函数的名字，这对于 `JSONP` 是必需的。
服务器收到这个请求以后，会将数据放在回调函数的参数位置返回。

```javascript
// node.js 服务器端对应代码
router.get('/ip', function(req, res) {
    res.setHeader('Content-Type', 'application/javascript');
    res.send('callback(' + JSON.stringify({"ip": "8.8.8.8"}) + ')');
});

```
由于 `<script>` 元素请求的脚本，直接作为代码运行。这时，只要浏览器定义了 `foo` 函数，该函数就会立即调用。**作为参数的` JSON` 数据被视为` JavaScript` 对象，而不是字符串，因此避免了使用 `JSON.parse` 的步骤**。

### 三、代码实例

html 代码:

```html
<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>

<h3>动态生成 <code>&lt;script&gt;</code></h3>
<button class="btn btn-primary btn-lg btn-block" onclick="calltest();">调用测试</button>
<hr/>

<script type="text/javascript">
	 function jsonp(url, data, callbackA) {
        var script = document.createElement('script');
        document.body.appendChild(script);

        data = data || {};
        data.callbackB = 'cb' + new Date().getTime();// 每次请求的 url 都不同，避免缓存问题
        window[data.callbackB] = callbackA;

        url += '?' + $.param(data);// 参数序列化
        // console.log('url: ' +url);

        script.src = url;
        script.onload = function () {
            document.body.removeChild(script);
        }

    }

    function calltest() {
        jsonp('http://b.test.com/testJsonp', {test: 'ok'}, function (data) {
            console.log(data);
        });
    }
</script>

</body>
</html>
```

服务器端代码:
```javascript
router.get('/testJsonp', function(req, res) {
    res.setHeader('Content-Type', 'application/javascript'); //cb123({a:1,b:2})
    res.send(req.query.callbackB + '(' + JSON.stringify({
        a: 3,
        b: 4
    }) + ')');
});
```
注意上面的 callbackA 和 callbackB 的区别:
- callbackA: 是请求成功后调用函数名称。
- callbackB: 是作为 `get` 请求的参数传到服务器端，后台可以通过它取到 `callbackA` 值，这样后台就可以根据传递不同的参数，自动返回相应的回调函数名称。


### 参考：
- [JSONP](http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html)
