---
title: 微信网页授权认证实例
date: 2017-05-02 14:34:39
updated: 2017-05-02 14:34:39
categories: WeChat
---

本文记录，微信网页认证调试过程，开发环境 `node.js`

## 一、安装

```
bash $ npm install wechat-oauth
```

## 二、node.js 中引入

```js 
var OAuth = require('wechat-oauth'); var client = new OAuth('your appid', 'your secret');
```

上面的 `your appid` 是你公众号的 id，`your secret` 是你公众号密钥，在公众号后台都可以查看到

## 三、转换网址

在微信中跳转到外部链接，如果需要在该页面获取到微信用户的 `openid` 或者 `userinfo` 就需要微信授权。 所以首先需要把跳转的页面地址转换为带参数的认证过的网址。 `js let authUrl = client.getAuthorizeURL(redirect, state, scope);`

  * redirect: 需要跳转的页面地址
  * state: 可自定义传递参数，长度不能超过 128 字节
  * scope：`snsapi_base`：只获取 `openid` ; `snsapi_userinfo`: 还可以获取微信用户信息。

  


例如: 
```js 
let authUrl = client.getAuthorizeURL('http://jessechiu.com/weichat', 'hello', 'userinfo'); 

// authUrl: https://open.weixin.qq.com/connect/oauth2/authorize?appi d=wx7a1c56bbd19d157e&redirect_uri=http%3A%2F%2Fjessechiu.com%2Fweichat&response_ type=code&scope=snsapi_userinfo&state=hello#wechat_redirect
```

**注意：官方文档规定，转换后的网址长度不能超过 256 字节**



## 四、获取用户信息

在上步生成的 `authUrl` 地址，当用户点击或者从菜单 `VIEW` 事件进入时，可以通过后台的对应路由获取对应的参数信息，进而获取用户的 `openid` 和 `userinfo` 信息。 

```js 
router.get('/weichat',(req,res,next)=>{ 

	let code = req.query.code; // 该值有微信后台生成，用来后面函数操作 
	let state = req.query.state;// 网址转换时传人的参数

	console.log('\n /weichat -> req.query.code: ' \+ code); console.log('\n /weichat -> req.query.state: ' \+ state);

	tools.getAuthorizeOpenid(code)
	.then(tools.getAuthorizeUserinfo)
	.then((userinfo)=>{ res.render('weichat',{}); })
	.catch((err)=>{ 
	console.error('\n err: ' \+ JSON.stringify(err)); 
	}); 
}); 
```

## 参考

  * [网页授权获取用户基本信息](https://mp.weixin.qq.com/wiki/9/01f711493b5a02f24b04365ac5d8fd95.html)
  * [wechat-oauth git](https://github.com/node-webot/wechat-oauth)
  * [微信公共平台 OAuth API 文档](http://doxmate.cool/node-webot/wechat-oauth/api.html)


