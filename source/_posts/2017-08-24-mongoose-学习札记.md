---
title: Mongoose 学习札记
date: 2017-08-24 10:24:54
updated: 2017-08-24 10:24:54
categories: Database
---
>下面是 Node.js 环境下实例代码

## 一、连接数据库
```js
// mongoose 链接
let mongoose = require('mongoose');
// 连接数据库，如果数据库不存在则自动创建一个
mongoose.connect('mongodb://kuku:kuku@127.0.0.1:27017/kuku',{useMongoClient: true});
`kuku:kuku 用户名:密码，/kuku 指的是需要连接的数据库`

// 链接错误
let db = mongoose.connection;
db.on('error', console.error.bind(console, 'connection error:'));

// 数据成功打开时回调
db.once('open', function() {
  console.log(`mongodb are connected!`);
});
```

## 二、创建数据库表
```js
// Schema 结构
var mongooseSchema = new mongoose.Schema({
    username : {type : String, default : '匿名用户'},
    title    : {type : String},
    content  : {type : String},
    time     : {type : Date, default: Date.now},
    age      : {type : Number}
});
```

## 三、对数据库的 CRUD 操作
有两种方式，一种是实例方法，另一种是静态方法 
```js
// 添加 mongoose 实例方法
mongooseSchema.methods.findbyusername = function(username, callback) {
    return this.model('mongoose').find({username: username}, callback);
}
// 添加 mongoose 静态方法，静态方法在Model层就能使用
mongooseSchema.statics.findbytitle = function(title, callback) {
    return this.model('mongoose').find({title: title}, callback);
}
```
### 3.1 添加数据
```js
// model
var mongooseModel = db.model('mongoose', mongooseSchema);
// 增加记录 基于 entity 操作
var doc = {username : 'emtity_demo_username', title : 'emtity_demo_title', content : 'emtity_demo_content'};
var mongooseEntity = new mongooseModel(doc);
mongooseEntity.save(function(error) {
    if(error) {
        console.log(error);
    } else {
        console.log('saved OK!');
    }
    // 关闭数据库链接
    db.close();
});

// 增加记录 基于model操作
var doc = {username : 'model_demo_username', title : 'model_demo_title', content : 'model_demo_content'};

mongooseModel.create(doc, function(error){
    if(error) {
        console.log(error);
    } else {
        console.log('save ok');
    }
    // 关闭数据库链接
    db.close();
});
```

### 3.2 修改记录
```js
// 修改记录
mongooseModel.update(conditions, update, options, callback);
var conditions = {username : 'model_demo_username'};
var update     = {$set : {age : 27, title : 'model_demo_title_update'}};
var options    = {upsert : true};
mongooseModel.update(conditions, update, options, function(error){
    if(error) {
        console.log(error);
    } else {
        console.log('update ok!');
    }
    //关闭数据库链接
    db.close();
});
```

### 3.3 查询
```js
// 基于实例方法的查询
var mongooseEntity = new mongooseModel({});
mongooseEntity.findbyusername('model_demo_username', function(error, result){
    if(error) {
        console.log(error);
    } else {
        console.log(result);
    }
    //关闭数据库链接
    db.close();
});

// 基于静态方法的查询
mongooseModel.findbytitle('emtity_demo_title', function(error, result){
    if(error) {
        console.log(error);
    } else {
        console.log(result);
    }
    //关闭数据库链接
    db.close();
});

// mongoose find
var criteria = {title : 'emtity_demo_title'}; // 查询条件
var fields   = {title : 1, content : 1, time : 1}; // 待返回的字段
var options  = {};
mongooseModel.find(criteria, fields, options, function(error, result){
    if(error) {
        console.log(error);
    } else {
        console.log(result);
    }
    //关闭数据库链接
    db.close();
});

// 还可以使用 $gt(>)、$lt(<)、$lte(<=)、$gte(>=) 操作符进行排除性的查询
mongooseModel.find({"age":{"$gt":18}},function(error,docs){
   //查询所有 age 大于 18 的数据
});
mongooseModel.find({"age":{"$lt":60}},function(error,docs){
   //查询所有 age 小于 60 的数据
});
mongooseModel.find({"age":{"$gt":18,"$lt":60}},function(error,docs){
   //查询所有 age 大于 18 小于 60 的数据
});

// $ne(!=) 操作符的含义相当于不等于、不包含，查询时我们可通过它进行条件判定，具体使用方法如下：
mongooseModel.find({ age:{ $ne:24}},function(error,docs){
    //查询 age 不等于 24 的所有数据
});

mongooseModel.find({name:{$ne:"tom"},age:{$gte:18}},function(error,docs){
  //查询 name 不等于 tom、age>=18 的所有数据
});

// $in 相当于包含、等于，查询时查找包含于指定字段条件的数据
mongooseModel.find({ age:{ $in: 20}},function(error,docs){
   //查询 age 等于 20 的所有数据
});

mongooseModel.find({ age:{$in:[20,30]}},function(error,docs){
  //可以把多个值组织成一个数组
}); 

// $or 操作符，可以查询多个键值的任意给定值，只要满足其中一个就可返回，用于存在多个条件判定的情况下使用
mongooseModel.find({"$or":[{"name":"yaya"},{"age":28}]},function(error,docs){
  //查询 name 为 yaya 或 age 为 28 的全部文档
});

// $exists 操作符，可用于判断某些关键字段是否存在来进行条件查询
mongooseModel.find({name: {$exists: true}},function(error,docs){
  //查询所有存在 name 属性的文档
});

mongooseModel.find({telephone: {$exists: false}},function(error,docs){
  //查询所有不存在 telephone 属性的文档
});

// 结果排序：find(Conditions,fields,options,callback);
mongooseModel.find({},null,{sort:{age:-1}},function(err,docs){
  //查询所有数据，并按照 age 降序顺序返回数据 docs
});

// 限制数量：find(Conditions,fields,options,callback);
mongooseModel.find({},null,{limit:20},function(err,docs){
    console.log(docs);
});

// 跳过数量：find(Conditions,fields,options,callback);
mongooseModel.find({},null,{skip:4},function(err,docs){
    console.log(docs);
});
```

### 3.4 删除记录
```js
var conditions = {username: 'emtity_demo_username'};
mongooseModel.remove(conditions, function(error){
    if(error) {
        console.log(error);
    } else {
        console.log('delete ok!');
    }

    //关闭数据库链接
    db.close();
});
```

## 四、实例代码
### 4.1 根据条件查询(支持分页)
```js
// 查询图书,多个条件是 与 的关系
function queryBooks(configObj) {
  console.log(`queryBooks(${JSON.stringify(configObj)})`);
  configObj = configObj || {};

  // 设置查询 与 条件
  let conditions = {
    $and:[]
  };

  configObj.title && (conditions['$and'].push({
    title: {$regex: (new RegExp(configObj.title, 'i'))} // 书名支持模糊查询,i 表示不区分大小写
  }));  

  configObj.author && (conditions['$and'].push({
    author: {$in:[configObj.author]}
  }));  
  configObj.category && (conditions['$and'].push({
    category: configObj.category
  }));
  // 如果条件为空,则重置条件变量
  if(conditions['$and'].length === 0){
    conditions = {};
  }

  let options = {
    skip: configObj.start,
    limit: configObj.count,
    sort: {
      creatTime: 1
    } // -1 降序，1 升序
  }

  return new Promise((resolve, reject) => {
    booksModel.find(conditions, null, options,(error, result) => {
      if (error) {
        console.log(`queryBooks() error: ${JSON.stringify(error)}`);
        return reject(error);
      }
      console.log(`queryBooks() success: ${JSON.stringify(result)}`);
      return resolve(result);
    })
  });
}

// 测试代码
queryBooks({
  title:'《JavaScript高级程序设计（第3版）》',
  author: '李可',
  category:'技术',
  start:0,
  count: 2
})
```

### 4.2 根据条件查询数据条数
```js
function getBooksCount(configObj) {
  console.log(`getBooksCount(${JSON.stringify(configObj)})`);
  configObj = configObj || {};

  return new Promise((resolve, reject) => {
    booksModel.count(configObj,(error, result) => {
      if (error) {
        console.log(`getBooksCount() error: ${JSON.stringify(error)}`);
        return reject(error);
      }
      console.log(`getBooksCount() success: ${JSON.stringify(result)}`);
      return resolve(result);
    })
  });
}
// 测试代码
getBooksCount(); // 结果是总条数

getBooksCount({
    author: '李可'
}); // 结果是 作者 === '李可' 的数据条数

getBooksCount({
    author: '李可',
    category:'技术
}); // 结果是 (作者 === '李可' && category === '技术') 的数据条数
```
## 参考
- [node.js 下 mongoose 简单操作实例](https://cnodejs.org/topic/51ff720b44e76d216afe34d9)