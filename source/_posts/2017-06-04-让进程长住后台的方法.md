---
title: 让进程常驻后台方法
date: 2017-06-04 10:16:29
categories: Linux
---

>我们经常会碰到这样的问题，用 telnet/ssh 登录了远程的 Linux 服务器，运行了一些耗时较长的任务， 结果却由于网络的不稳定导致任务中途失败。如何让命令提交后不受本地关闭终端窗口/网络断开连接的干扰呢？请看下面的方法介绍。

## 场景一
如果只是临时有一个命令需要长时间运行，什么方法能最简便的保证它在后台稳定运行呢？
主要有下面三个方法：
### 1. `nohup`
`nohup` 的用途就是让提交的命令忽略 `hangup` 信号，也就是窗口关闭时发出的信号。
```bash
nohup ping www.jessechiu.com &
```

### 2. `setsid`
`setsid` 是直接把进程的父进程设置为初始进场，`ppid:1`;这样即使窗口(父进程关闭)也不会受影响。
```bash
setsid ping www.jessechiu.com
```

### 3. `(ping www.jessechou.com &)`
效果同 第二种 方法一样。
```bash
(ping www.jessechou.com &)
```

## 场景二
如果事先在命令前加上 nohup 或者 setsid 就可以避免 HUP 信号的影响。但是如果我们未加任何处理就已经提交了命令，该如何补救才能让它避免 HUP 信号的影响呢？
可以使用 `disown` 命令解决，具体看下面两个实例
### 例 1：
如果提交命令时已经用 `&` 将命令放入后台运行，则可以直接使用 `disown`
```bash
[root@pvcent107 build]# cp -r testLargeFile largeFile &
[1] 4825
[root@pvcent107 build]# jobs
[1]+  Running                 cp -i -r testLargeFile largeFile &
[root@pvcent107 build]# disown -h %1
[root@pvcent107 build]# ps -ef |grep largeFile
root      4825   968  1 09:46 pts/4    00:00:00 cp -i -r testLargeFile largeFile
root      4853   968  0 09:46 pts/4    00:00:00 grep largeFile
[root@pvcent107 build]# logout
```
### 例 2：
如果提交命令时未使用`&` 将命令放入后台运行，可使用 `CTRL-z` 和 `bg` 将其放入后台，再使用 `disown`
```bash
[root@pvcent107 build]# cp -r testLargeFile largeFile2

[1]+  Stopped                 cp -i -r testLargeFile largeFile2
[root@pvcent107 build]# bg %1
[1]+ cp -i -r testLargeFile largeFile2 &
[root@pvcent107 build]# jobs
[1]+  Running                 cp -i -r testLargeFile largeFile2 &
[root@pvcent107 build]# disown -h %1
[root@pvcent107 build]# ps -ef |grep largeFile2
root      5790  5577  1 10:04 pts/3    00:00:00 cp -i -r testLargeFile largeFile2
root      5824  5577  0 10:05 pts/3    00:00:00 grep largeFile2
[root@pvcent107 build]#

## 场景三
如果想在开机时自动启动，可以把需要执行的命令放到 `/etc/rc.local` 文件中
```

## 参考
- [让进程在后台可靠运行的几种方法](https://www.ibm.com/developerworks/cn/linux/l-cn-nohup/)