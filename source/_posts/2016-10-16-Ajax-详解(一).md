---
title: Ajax 详解(一)
date: 2016-10-16 21:47:51
updated: 2016-10-16 21:47:51
tags:
categories: Ajax
feature:
---
### 一、什么是 AJAX?

AJAX (Asynchronous JavaScript and XML)代表异步 Javascript & XML，是个新产生的术语,专为描述 JavaScript 的两项强大性能.这两项性能在多年来一直被网络开发者所忽略,直到最近 Gmail, Google Suggest 和 Google Maps 的横空出世才使人们开始意识到其重要性.

这两项被忽视的性能是:

1. 无需重新装载整个页面便能向服务器发送请求.
2. 对 XML 文档的解析和处理

### 二、如何发送一个 HTTP 请求

为了用 JavaScript 向服务器发送一个 HTTP 请求, 需要一个具备这种功能的类实例. 这样的类首先由 Internet Explorer 以 ActiveX 对象引入, 被称为 XMLHTTP. 后来 Mozilla, Safari 和其他浏览器纷纷仿效, 提供了 XMLHttpRequest 类,它支持微软的 ActiveX 对象所提供的方法和属性.

因此, 为了创建一个跨浏览器的这样的类实例(对象), 可以应用如下代码:

```javascript
if (window.XMLHttpRequest) { // Mozilla, Safari, ...
    http_request = new XMLHttpRequest();
} else if (window.ActiveXObject) { // IE
    http_request = new ActiveXObject("Microsoft.XMLHTTP");
}
```
(上例对代码做了一定简化,这是为了解释如何创建XMLHTTP类实例. 实际的代码实例可参阅本篇步骤3.)

如果服务器的响应没有 XML mime-type header,某些 Mozilla 浏览器可能无法正常工作. 为了解决这个问题, 如果服务器响应的 header 不是 text/xml,可以调用其它方法修改该 header.
```javascript
http_request = new XMLHttpRequest();
http_request.overrideMimeType('text/xml');
```
接下来要决定当收到服务器的响应后,需要做什么.这需要告诉 HTTP 请求对象用哪一个JavaScript函数处理这个响应.可以将对象的onreadystatechange属性设置为要使用的JavaScript的函数名,如下所示:

```javascript
http_request.onreadystatechange = function(){
    // do the thing
};
http_request.open('GET', 'http://www.example.org/some.file', true);
http_request.send(null);
```

open():

第一个参数是 HTTP 请求方式 – GET, POST, HEAD 或任何服务器所支持的您想调用的方式. 按照 HTTP 规范,该参数要 **大写**;否则,某些浏览器(如 Firefox)可能无法处理请求.有关 HTTP 请求方法的详细信息可[参考](http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html W3C specs)

第二个参数是请求页面的 URL.由于 **自身安全特性的限制**,该页面不能为 **第三方域名** 的页面.同时一定要保证在所有的页面中都使用准确的域名,否则调用 open() 会得到 "permission denied" 的错误提示.一个常见的错误是访问站点时使用 domain.tld,而当请求页面时,却使用 www.domain.tld.

第三个参数设置请求是否为异步模式.如果是TRUE, JavaScript 函数将继续执行,而不等待服务器响应.这就是"AJAX"中的"A".
如果第一个参数是"POST",

send():
方法的参数可以是任何想送给服务器的数据. 这时数据要以字符串的形式送给服务器,如下所示:

`name=value&anothername=othervalue&so=on`

### 三、处理服务器的响应

当发送请求时,要提供指定处理响应的 JavaScript 函数名.

`http_request.onreadystatechange = nameOfTheFunction;`

我们来看看这个函数的功能是什么.首先函数会检查请求的状态.如果状态值是4,就意味着一个完整的服务器响应已经收到了,您将可以处理该响应.

```javascript
if (http_request.readyState == 4) {
    // everything is good, the response is received
} else {
    // still not ready
}
readyState的取值如下:

0 (未初始化)
1 (正在装载)
2 (装载完毕)
3 (交互中)
4 (完成)
(Source)

接着,函数会检查HTTP服务器响应的状态值. 完整的状态取值可参见 W3C site. 我们着重看值为200 OK的响应.

if (http_request.status == 200) {
    // perfect!
} else {
    // there was a problem with the request,
    // for example the response may be a 404 (Not Found)
    // or 500 (Internal Server Error) response codes
}
```

在检查完请求的状态值和响应的HTTP状态值后, 您就可以处理从服务器得到的数据了.有两种方式可以得到这些数据:

http_request.responseText – 以文本字符串的方式返回服务器的响应
http_request.responseXML – 以 XMLDocument 对象方式返回响应.处理 XMLDocument 对象可以用 JavaScript DOM 函数

### 四、简单实例

我们现在将整个过程完整地做一次,发送一个简单的 HTTP 请求. 我们用 JavaScript 请求一个 HTML 文件, test.html, 文件的文本内容为 "I'm a test.".然后我们 "alert()"test.html 文件的内容.

```javascript
<script type="text/javascript" language="javascript">

    var http_request = false;

    function makeRequest(url) {

        http_request = false;

        if (window.XMLHttpRequest) { // Mozilla, Safari,...
            http_request = new XMLHttpRequest();
            if (http_request.overrideMimeType) {
                http_request.overrideMimeType('text/xml');
            }
        } else if (window.ActiveXObject) { // IE
            try {
                http_request = new ActiveXObject("Msxml2.XMLHTTP");
            } catch (e) {
                try {
                    http_request = new ActiveXObject("Microsoft.XMLHTTP");
                } catch (e) {}
            }
        }

        if (!http_request) {
            alert('Giving up :( Cannot create an XMLHTTP instance');
            return false;
        }
        http_request.onreadystatechange = alertContents;
        http_request.open('GET', url, true);
        http_request.send(null);

    }

    function alertContents() {

        if (http_request.readyState == 4) {
            if (http_request.status == 200) {
                alert(http_request.responseText);
            } else {
                alert('There was a problem with the request.');
            }
        }

    }
</script>
<span
    style="cursor: pointer; text-decoration: underline"
    onclick="makeRequest('test.html')">
        Make a request
</span>
```

本例中:

用户点击浏览器上的"请求"链接;
接着函数 makeRequest()将被调用.其参数 – HTML文件test.html在同一目录下;
这样就发起了一个请求.onreadystatechange的执行结果会被传送给alertContents();
alertContents()将检查服务器的响应是否成功地收到,如果是,就会"alert()"test.html文件的内容.
您可以点击测试该实例,测试文件为.

### 五、处理XML响应

在前面的例子中,当服务器对 HTTP 请求的响应被收到后,我们会调用请求对象的 reponseText 属性.该属性包含了test.html文件的内容.现在我们来试试 responseXML 属性.

首先,我们新建一个有效的XML文件,后面我们将使用这个文件.该文件(test.xml)源代码如下所示:

```javascript
<?xml version="1.0" ?>
<root>
    I'm a test.
</root>

在该脚本中,我们只需修改请求部分:

...
onclick="makeRequest('test.xml')">
...

接着,在alertContents()中,我们将 alert() 的代码 alert(http_request.responseText); 换成:

var xmldoc = http_request.responseXML;
var root_node = xmldoc.getElementsByTagName('root').item(0);
alert(root_node.firstChild.data);
```

这里,我们使用了 responseXML 提供的 XMLDocument 对象并用DOM方法获取存于 XML 文件中的内容.

### 参考
- [Getting_Started](https://developer.mozilla.org/zh-CN/docs/AJAX/Getting_Started)