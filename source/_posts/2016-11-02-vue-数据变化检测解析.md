---
title: Vue 数据变化检测解析
date: 2016-11-02 14:26:04
updated: 2016-11-02 14:26:04
tags:
categories: Vue.js
feature:
---

## 一、概述
受现代 Javascript 的限制(以及 `Object.observe` 的废弃)，Vue **不能检测到对象属性的添加或删除**。因为 Vue 在初始化实例时将属性转为 `getter/setter`，所以属性必须在 `data` 对象上才能让 Vue 转换它，这样才能让它是响应的。例如：

```js
var vm = new Vue({

data:{

a:1

  }

})

// `vm.a` 是响应的
vm.b = 2
// `vm.b` 是非响应的
```

Vue 不允许在已经创建的实例上动态添加新的根级响应式属性（root-level reactive properties）。然而它可以使用 `Vue.set(object, key, value)` 方法将响应属性添加到 **嵌套的对象** 上：

`Vue.set(vm.someObject, 'b', 2)`

您还可以使用 `vm.$set` 实例方法，这也是全局 `Vue.set` 方法的别名：

`this.$set(this.someObject,'b',2)`

有时你想向已有对象上添加一些属性，例如使用 `Object.assign()` 或 `_.extend()` 方法来添加属性。但是，添加到对象上的新属性不会触发更新。在这种情况下可以创建一个新的对象，让它包含原对象的属性和新的属性：

```js
// 代替 `Object.assign(this.someObject, { a: 1, b: 2 })`
this.someObject = Object.assign({}, this.someObject, { a: 1, b: 2 })
```

也有一些数组相关的问题，之前已经在 [列表渲染](https://vuefe.cn/guide/list.html#Caveats) 中讲过。

由于 Vue 不允许动态添加根级响应式属性，所以你必须在初始化实例前声明根级响应式属性，哪怕只是一个空值:

```js
var vm = new Vue({

data: {

// 声明 message 为一个空值字符串

    message: ''

  },

template: '<div>{{ message }}</div>'

})

// 之后设置 `message` 

vm.message = 'Hello!'
```

如果你不在 data 对象中声明 `message`，Vue 将发出警告表明你的渲染方法正试图访问一个不存在的属性。

这样的限制在背后是有其技术原因的，在依赖项跟踪系统中，它消除了一类边界情况，也使 Vue 实例在类型检查系统的帮助下运行的更高效。在代码可维护性方面上这也是重要的一点：`data` 对象就像组件状态的模式（Schema），在它上面声明所有的属性让组织代码更易于被其他开发者或是自己回头重新阅读时更加快速地理解。[](https://vuefe.cn/guide/reactivity.html#异步更新队列)


## 二、测试代码：
html:
```html
<div id="app">
	name: <input type="text" v-model="name"> : <span>{{name}}</span> <br>
	sex: <input type="text" v-model="sex"> : <span>{{sex}}</span> <br>
	b(非响应式): <input type="text" v-model="b"> : <span>{{b}}</span> <br>
	c(非响应式): <input type="text" v-model="c"> : <span>{{c}}</span> <br>
	d: <input type="text" v-model="append.d"> : <span>{{append.d}}</span> <br>
	e: <input type="text" v-model="append.e"> : <span>{{append.e}}</span> <br>
</div>
```

js:
```js
<script type="text/javascript">

	var vm = new Vue({
	  el: '#app',
	  data: {
	  	name:'jesse',
	  	sex:'',
	  	append:{} // 值是一个对象
	  }
	});

	vm.sex = 'man';
	vm.b = 2 // `vm.b` 不是响应的
	vm.$set(vm.$data,'c',3); // vm.c 不是响应式

	// 下面两个是响应式
	// Vue.set(vm.append,'d',3);
	// vm.$set(vm.append,'e',4); 
	
	// 等价于下面方法
	vm.append = Object.assign({},vm.append,{d:4,e:5});
	setTimeout(function(){
		console.log('timeout');
		// 异步更新队列
		console.log('vm.$el.textContent-1: ' + vm.$el.textContent);
		Vue.nextTick(function(){
			console.log('vm.$el.textContent-2: ' + 	vm.$el.textContent);
		});
	},2000);

</script>
```

