---
title: Webpack 原理解析(一)
date: 2016-10-20 13:55:26
updated: 2016-10-20 13:55:26
tags: Webpack
categories: Tools
feature:
---

> Webpack 可以识别 CommonJS 和 AMD 方式定义的模块，并且会自动根据代码的依赖关系，分别打包，按需自动加载。下面是对这个部分原理的解析。

## 一、测试工程
1. CommonJS 模块文件
```javascript
// a.js
module.exports = 'Hello i am a.js';

------------------------------------------------------------------------------

// b.js
// 这里省略了多余代码，主要是增加文件大小，为后面的测试用
module.exports = "Hello i am b.js";
```

2. AMD 模块文件
```javascript
// c.js

// 方式一
define(['./a.js'], function(a) {
	return {
		sayHello: function sayHello() {
			console.log('Hello i am c.js');
		}
	};
});

// 方式二
define(function(require) {
	var a = require('./a.js');
	return {
		sayHello: function() {
			console.log('Hello i am c.js');
		}
	}
});

// 在打包 c.js 模块是会包含 a.js 模块。
```
	上面的两种方式定义效果是一样的，只不过 **方式二** 是 **方式一** 的语法糖写法

3. 入口文件
```javascript
// main1.js
require.ensure(['./a'], function(require) {

	// webpack 会根据下面的语句单独打包生成 1.bundle-1.js
	var content = require('./a');

	document.open();
	document.write('<h1>' + content + '</h1>');

	var script = document.createElement('script');
	script.innerText = setTimeout(function() {
		// webpack 会根据下面的语句单独打包生成 2.bundle-2.js
		// 初始时并没加载，过了 2 秒后才会加载
		require(['./b.js'], function(a) {
			console.log(a);
		});
	}, 2000);

	document.close();
});

// webpack 会根据配置文件 webpack.config.js 的入口参数对象 main1.js 中的 require 
// 个数自动分别打相应个数的包，改文件打了 2 个包(1.bundle-1.js，2.bundle-2.js)和一个 bundle-main1.js

------------------------------------------------------------------------------

// main2.js
// webpack 会根据下面的语句单独打包生成 4.bundle-4.js,包含了 a.js 的内容。
require(['./c.js'],function(c){
	c.sayHello();
})

// webpack 会根据配置文件 webpack.config.js 的入口参数对象 main2.js 中的 require 
// 个数自动分别打相应个数的包，改文件打了 1 个包(4.bundle-4.js)和一个 bundle-main2.js
```

4. webpack 配置文件
```javascript
// webpack.config.js
module.exports = {
  entry: {
  	main1: './main1.js',
  	main2: './main2.js'
  },
  output: {
    filename: 'bundle-[name].js'
  }
};
```

5. index.html 文件
```html
<html>
  <body>
    <script src="bundle-main1.js"></script>
    <script src="bundle-main2.js"></script>
  </body>
</html>
```

## 二、使用 webpack 命令打包
```bash
> webpack
// 如果使用 webpack -p 生产方式打包，生成的分包名称会有所差别
```
在同级目录下回多出 5 文件

- `1.bundle-1.js`  // a.js
- `2.bundle-2.js`  // b.js
- `4.bundle-4.js`  // c.js a.js
- `bundle-main1.js` // main1.js
- `bundle-main2.js` // main2.js

可以看到 webpack 生成两个 5 个包文件，其中两个 `bundle-main1.js` 和 `bundle-main2.js` 两个主文件，也是我们 `index.html` 文件引用的文件，其它三个文件是 `webpack` 根据 `main1.js` 和 `main2.js` 中使用 `require(moduleName,callback)` 自动分别打包生成，在 `index.html` 运行时按需自动加载。例如上面测试代码 `main1.js` 中有设置了一个定时器，2 秒后加载 `b.js`,也就是 `2.bundle-2.js`(`b.js` 打包生成) 文件是在加载完 `index.html` 文件 2 秒后才运行。

## 三、运行测试代码
使用浏览器打开 `index.html` 文件，打开控制台查看日志信息变化。

<div>
<iframe width="100%" height="300" src="http://od6sd4xau.bkt.clouddn.com/webpack-1.gif">
</div>

从上面的视频可以看到在刷新页面后，过了 2 秒 `2.bundle-2.js` 才加载。


#### [下载完整测试代码](http://od6sd4xau.bkt.clouddn.com/Webpack-%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90%28%E4%B8%80%29-code.rar)





