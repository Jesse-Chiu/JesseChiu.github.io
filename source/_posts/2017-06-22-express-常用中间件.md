---
title: Express 常用中间件
date: 2017-06-22 14:34:39
updated: 2017-06-22 14:34:39
categories: Node.js
---
> 本文主要收集 Express 中常用的中间件的使用方法

## 一、`cookie-parse`
基础用法
```js
var express = require('express');
var app = express();
var cookieParser = require('cookie-parser');

// 如果在 res.cookie 设置 signed:true，在这里必需传人一个 secret 用于签名
app.use(cookieParser('3d48ed43942b031f995cf34b1419a2fe'));

// 默认首页加载页面
app.get('/', function(req, res) {
  console.log(`\name: ${req.cookies.name} sex: ${req.signedCookies.sex}
    car1: ${req.cookies.car1} car2: ${req.signedCookies.car2}`);

	// 设置明文 cookie
  res.cookie('name','jesse');
  // 设置带签名 cookie
  res.cookie('sex','man',{signed:true});
  // 设置加密 cookie
  res.cookie('age','18',{secure:true}); // 这个值对 https 有效

	// 设置明文 JSON 类型 cookie
  res.cookie('car1',JSON.stringify({
    color:'red',
    speed:100
  })); 

	// 设置签名 JSON 类型 cookie
  res.cookie('car2',JSON.stringify({
    color:'blue',
    speed: 200
  }),{signed:true});

  res.render('index', {currentTime: new Date()});
});

//-----------------------------------------------
在浏览器的开发工具中查看到的值：
name: 'jesse'
sex: 's%3Aman.bgKlzHHA5q%2B6jEdT%2BbwiJTLoYdvUX7plg3AAdcH1oW8'
	- decodeURIComponent('s%3Aman.bgKlzHHA5q%2B6jEdT%2BbwiJTLoYdvUX7plg3AAdcH1oW8')
	- "s:man.bgKlzHHA5q+6jEdT+bwiJTLoYdvUX7plg3AAdcH1oW8"
car1: %7B%22color%22%3A%22red%22%2C%22speed%22%3A100%7D
car2: s%3A%7B%22color%22%3A%22blue%22%2C%22speed%22%3A200%7D.pjlpa%2Bvo9Ujms2kpq5BFbsHrjZBAHGPBUc5OHeZHBIQ
```
从上面的设置 `cookie` 结果可以看出,不管是设置明文还是签名的 cookie，都会使用 `encodeURIComponent` 进行编码，当然也可在初始化时使用自定义的加解密函数处理。

使用中需要注意的点：
- 设置 `req.cookie(key,value,options)`
- 取值 `res.cookies(key)/res.singedCookies(key)` // 注意： cookie 有加 s
- 删除可以统一使用：`res.clearCookie(key)`; 如果设置的时候有设置 `path`,删除时也需要带上: 
```js
res.cookie('name', 'tobi', { path: '/admin' });
res.clearCookie('name', { path: '/admin' });
```

## 二、`express-session`
使用前须知：
- session 数据并没有存储在 cookie 中，只是存储了 session_id 值在 cookie 中.
- session 如果和 `cookie-parse` 中间件使用的 secret 不一样，可能会有一些问题。
简单配置使用
```js
let session = require('express-session');
// 挂载 session
app.use(session({
  cookie: {maxAge:  1000*60*60*2},// 有效时间 2 个小时
  // 强制没有“初始化”的 session 保存到 storage中，
  // 没有初始化的 session 指的是：刚被创建没有被修改
  saveUninitialized: false 
}));

// ...
// Use the session middleware
app.use(session({ secret: 'keyboard cat', cookie: { maxAge: 60000 }}))
// Access the session as req.session
app.get('/', function(req, res, next) {
  var sess = req.session
  if (sess.views) {
    sess.views++
    res.setHeader('Content-Type', 'text/html')
    res.write('<p>views: ' + sess.views + '</p>')
    res.write('<p>expires in: ' + (sess.cookie.maxAge / 1000) + 's</p>')
    res.end()
  } else {
    sess.views = 1
    res.end('welcome to the session demo. refresh!')
  }
})
```
**注意这里的取值和设置都是在 `req` 对象上，和 cookie 有所差别**
如果要删除 session 值: `delete req.session.xxxx;`


## 参考：
- [cookie-parse star:727](https://github.com/expressjs/cookie-parser)
- [express-session star:2379](https://github.com/expressjs/session#compatible-session-stores)
- [ node.js中express-session配置项详解](http://blog.csdn.net/liangklfang/article/details/50998959) 讲解非常详细，配合源码解析