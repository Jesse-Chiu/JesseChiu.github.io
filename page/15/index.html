<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Page 15 - Cease to struggle and you cease to live</title>
  <meta name="author" content="JesseChiu">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Cease to struggle and you cease to live"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Cease to struggle and you cease to live" type="application/atom+xml">
  
  
    <link href="/favicon.ico" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/spacelab.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <!-- analytics -->
  



</head>


 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Cease to struggle and you cease to live</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="">
			  <i class="fa fa-rss"></i>Rss
			</a>
		  </li>
		  
		  <li>
			<a href="/sitemap.xml" title="">
			  <i class="fa fa-sitemap"></i>Sitemap
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header page-header-inverse ">
  <h1 class="title title-inverse ">Cease to struggle and you cease to live</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Keep on going never give up.
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
        <!-- render top articles firstly -->
        
        <!-- render other articles -->
        
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-04-14 </div>
			<div class="article-title"><a href="/2017/04/14/2017-04-14-node-js-buffer/" >Buffer 对象</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><code>Buffer</code>对象是Node处理二进制数据的一个接口。它是Node原生提供的全局对象，可以直接使用，不需要<code>require(&#39;buffer&#39;)</code>。</p>
<p>JavaScript比较擅长处理字符串，对于处理二进制数据（比如TCP数据流），就不太擅长。<code>Buffer</code>对象就是为了解决这个问题而设计的。它是一个构造函数，生成的实例代表了V8引擎分配的一段内存，是一个类似数组的对象，成员都为0到255的整数值，即一个8位的字节。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个256字节的Buffer实例</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bytes = <span class="keyword">new</span> Buffer(<span class="number">256</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历每个字节，写入内容</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  bytes[i] = i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个buffer的view</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从240字节到256字节</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> end = bytes.slice(<span class="number">240</span>, <span class="number">256</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">end[<span class="number">0</span>] <span class="comment">// 240</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">end[<span class="number">0</span>] = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">end[<span class="number">0</span>] <span class="comment">// 0</span></span></pre></td></tr></table></figure>

<p>上面代码演示了如何生成<code>Buffer</code>对象实例，以及它的赋值和取值。</p>
<p>除了直接赋值，<code>Buffer</code>实例还可以拷贝生成。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bytes = <span class="keyword">new</span> Buffer(<span class="number">8</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  bytes[i] = i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> more = <span class="keyword">new</span> Buffer(<span class="number">4</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">bytes.copy(more, <span class="number">0</span>, <span class="number">4</span>, <span class="number">8</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">more[<span class="number">0</span>] <span class="comment">// 4</span></span></pre></td></tr></table></figure>

<p><strong>最新版本建议使用 <code>Buffer.from()</code> 替代</strong></p>
<p>上面代码中，<code>copy</code>方法将<code>bytes</code>实例的4号成员到7号成员的这一段，都拷贝到了<code>more</code>实例从0号成员开始的区域。</p>
<p><code>Buffer</code>对象与字符串的互相转换，需要指定编码格式。目前，Buffer对象支持以下编码格式。</p>
<ul>
<li>ascii</li>
<li>utf8</li>
<li>utf16le：UTF-16的小端编码，支持大于U+10000的四字节字符。</li>
<li>ucs2：utf16le的别名。</li>
<li>base64</li>
<li>hex：将每个字节转为两个十六进制字符。</li>
</ul>
<h2 id="与二进制数组的关系"><a href="#与二进制数组的关系" class="headerlink" title="与二进制数组的关系"></a>与二进制数组的关系</h2><p><code>TypedArray</code>构造函数可以接受<code>Buffer</code>实例作为参数，生成一个二进制数组。比如，<code>new Uint32Array(new Buffer([1, 2, 3, 4]))</code>，生成一个4个成员的二进制数组。注意，新数组的成员有四个，而不是只有单个成员（<code>[0x1020304]</code>或者<code>[0x4030201]</code>）。另外，这时二进制数组所对应的内存是从Buffer对象拷贝的，而不是共享的。二进制数组的<code>buffer</code>属性，保留指向原Buffer对象的指针。</p>
<p>二进制数组的操作，与Buffer对象的操作基本上是兼容的，只有轻微的差异。比如，二进制数组的<code>slice</code>方法返回原内存的拷贝，而Buffer对象的<code>slice</code>方法创造原内存的一个视图（view）。</p>
<h2 id="Buffer构造函数"><a href="#Buffer构造函数" class="headerlink" title="Buffer构造函数"></a>Buffer构造函数</h2><p><code>Buffer</code>作为构造函数，可以用<code>new</code>命令生成一个实例，它可以接受多种形式的参数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数是整数，指定分配多少个字节内存</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hello = <span class="keyword">new</span> Buffer(<span class="number">5</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数是数组，数组成员必须是整数值</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hello = <span class="keyword">new</span> Buffer([<span class="number">0x48</span>, <span class="number">0x65</span>, <span class="number">0x6c</span>, <span class="number">0x6c</span>, <span class="number">0x6f</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">hello.toString() <span class="comment">// 'Hello'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数是字符串（默认为utf8编码）</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hello = <span class="keyword">new</span> Buffer(<span class="string">'Hello'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">hello.length <span class="comment">// 5</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">hello.toString() <span class="comment">// "Hello"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数是字符串（不省略编码）</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hello = <span class="keyword">new</span> Buffer(<span class="string">'Hello'</span>, <span class="string">'utf8'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数是另一个Buffer实例，等同于拷贝后者</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hello1 = <span class="keyword">new</span> Buffer(<span class="string">'Hello'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hello2 = <span class="keyword">new</span> Buffer(hello1);</span></pre></td></tr></table></figure>

<p>下面是读取用户命令行输入的例子。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> Buffer(<span class="number">1024</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> readSize = fs.readSync(fs.openSync(<span class="string">'/dev/tty'</span>, <span class="string">'r'</span>), buffer, <span class="number">0</span>, bufferSize);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chunk = buffer.toString(<span class="string">'utf8'</span>, <span class="number">0</span>, readSize);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'INPUT: '</span> + chunk);</span></pre></td></tr></table></figure>

<p>运行上面的程序结果如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输入任意内容，然后按回车键</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">foo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">INPUT: foo</span></pre></td></tr></table></figure>

<h2 id="类的方法"><a href="#类的方法" class="headerlink" title="类的方法"></a>类的方法</h2><h3 id="Buffer-isEncoding"><a href="#Buffer-isEncoding" class="headerlink" title="Buffer.isEncoding()"></a>Buffer.isEncoding()</h3><p>Buffer.isEncoding方法返回一个布尔值，表示Buffer实例是否为指定编码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Buffer.isEncoding(<span class="string">'utf8'</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// true</span></span></pre></td></tr></table></figure>

<h3 id="Buffer-isBuffer"><a href="#Buffer-isBuffer" class="headerlink" title="Buffer.isBuffer()"></a>Buffer.isBuffer()</h3><p>Buffer.isBuffer方法接受一个对象作为参数，返回一个布尔值，表示该对象是否为Buffer实例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Buffer.isBuffer(<span class="built_in">Date</span>) <span class="comment">// false</span></span></pre></td></tr></table></figure>

<h3 id="Buffer-byteLength"><a href="#Buffer-byteLength" class="headerlink" title="Buffer.byteLength()"></a>Buffer.byteLength()</h3><p>Buffer.byteLength方法返回字符串实际占据的字节长度，默认编码方式为utf8。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Buffer.byteLength(<span class="string">'Hello'</span>, <span class="string">'utf8'</span>) <span class="comment">// 5</span></span></pre></td></tr></table></figure>

<h3 id="Buffer-concat"><a href="#Buffer-concat" class="headerlink" title="Buffer.concat()"></a>Buffer.concat()</h3><p>Buffer.concat方法将一组Buffer对象合并为一个Buffer对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i1 = <span class="keyword">new</span> Buffer(<span class="string">'Hello'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i2 = <span class="keyword">new</span> Buffer(<span class="string">' '</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i3 = <span class="keyword">new</span> Buffer(<span class="string">'World'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">Buffer.concat([i1, i2, i3]).toString()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 'Hello World'</span></span></pre></td></tr></table></figure>

<p>需要注意的是，如果Buffer.concat的参数数组只有一个成员，就直接返回该成员。如果有多个成员，就返回一个多个成员合并的新Buffer对象。</p>
<p>Buffer.concat方法还可以接受第二个参数，指定合并后Buffer对象的总长度。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i1 = <span class="keyword">new</span> Buffer(<span class="string">'Hello'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i2 = <span class="keyword">new</span> Buffer(<span class="string">' '</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i3 = <span class="keyword">new</span> Buffer(<span class="string">'World'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">Buffer.concat([i1, i2, i3], <span class="number">10</span>).toString()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 'Hello Worl'</span></span></pre></td></tr></table></figure>

<p>省略第二个参数时，Node内部会计算出这个值，然后再据此进行合并运算。因此，显式提供这个参数，能提供运行速度。</p>
<h2 id="实例属性"><a href="#实例属性" class="headerlink" title="实例属性"></a>实例属性</h2><h3 id="length"><a href="#length" class="headerlink" title="length"></a>length</h3><p>length属性返回Buffer对象所占据的内存长度。注意，这个值与Buffer对象的内容无关。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">buf = <span class="keyword">new</span> Buffer(<span class="number">1234</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">buf.length <span class="comment">// 1234</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">buf.write(<span class="string">"some string"</span>, <span class="number">0</span>, <span class="string">"ascii"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">buf.length <span class="comment">// 1234</span></span></pre></td></tr></table></figure>

<p>上面代码中，不管写入什么内容，length属性总是返回Buffer对象的空间长度。如果想知道一个字符串所占据的字节长度，可以将其传入Buffer.byteLength方法。</p>
<p>length属性是可写的，但是这会导致未定义的行为，不建议使用。如果想修改Buffer对象的长度，建议使用slice方法返回一个新的Buffer对象。</p>
<h2 id="实例方法"><a href="#实例方法" class="headerlink" title="实例方法"></a>实例方法</h2><h3 id="write"><a href="#write" class="headerlink" title="write()"></a>write()</h3><p><code>write</code>方法可以向指定的Buffer对象写入数据。它的第一个参数是所写入的内容，第二个参数（可省略）是所写入的起始位置（默认从0开始），第三个参数（可省略）是编码方式，默认为<code>utf8</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> Buffer(<span class="number">5</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">buf.write(<span class="string">'He'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">buf.write(<span class="string">'l'</span>, <span class="number">2</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">buf.write(<span class="string">'lo'</span>, <span class="number">3</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(buf.toString());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// "Hello"</span></span></pre></td></tr></table></figure>

<h3 id="slice"><a href="#slice" class="headerlink" title="slice()"></a>slice()</h3><p>slice方法返回一个按照指定位置、从原对象切割出来的Buffer实例。它的两个参数分别为切割的起始位置和终止位置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> Buffer(<span class="string">'just some data'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chunk = buf.slice(<span class="number">5</span>, <span class="number">9</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">chunk.toString()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// "some"</span></span></pre></td></tr></table></figure>

<h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString()"></a>toString()</h3><p><code>toString</code>方法将Buffer实例，按照指定编码（默认为<code>utf8</code>）转为字符串。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hello = <span class="keyword">new</span> Buffer(<span class="string">'Hello'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">hello <span class="comment">// &lt;Buffer 48 65 6c 6c 6f&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">hello.toString() <span class="comment">// "Hello"</span></span></pre></td></tr></table></figure>

<p><code>toString</code>方法可以只返回指定位置内存的内容，它的第二个参数表示起始位置，第三个参数表示终止位置，两者都是从0开始计算。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> Buffer(<span class="string">'just some data'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(buf.toString(<span class="string">'ascii'</span>, <span class="number">5</span>, <span class="number">9</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// "some"</span></span></pre></td></tr></table></figure>

<h3 id="toJSON"><a href="#toJSON" class="headerlink" title="toJSON()"></a>toJSON()</h3><p>toJSON方法将Buffer实例转为JSON对象。如果JSON.stringify方法调用Buffer实例，默认会先调用toJSON方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> Buffer(<span class="string">'test'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> json = <span class="built_in">JSON</span>.stringify(buf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">json <span class="comment">// '[116,101,115,116]'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> copy = <span class="keyword">new</span> Buffer(<span class="built_in">JSON</span>.parse(json));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">copy <span class="comment">// &lt;Buffer 74 65 73 74&gt;</span></span></pre></td></tr></table></figure>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-04-14 </div>
			<div class="article-title"><a href="/2017/04/14/2017-04-14-node-js-child-process/" >Child Process 模块</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>child_process模块用于新建子进程。子进程的运行结果储存在系统缓存之中（最大200KB），等到子进程运行结束以后，主进程再用回调函数读取子进程的运行结果。</p>
<h2 id="exec"><a href="#exec" class="headerlink" title="exec()"></a>exec()</h2><p><code>exec</code>方法用于执行bash命令，它的参数是一个命令字符串。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> exec = <span class="built_in">require</span>(<span class="string">'child_process'</span>).exec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ls = exec(<span class="string">'ls -l'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, stdout, stderr</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (error) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">console</span>.log(error.stack);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Error code: '</span> + error.code);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Child Process STDOUT: '</span> + stdout);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<p>上面代码的<code>exec</code>方法用于新建一个子进程，然后缓存它的运行结果，运行结束后调用回调函数。</p>
<p><code>exec</code>方法最多可以接受两个参数，第一个参数是所要执行的shell命令，第二个参数是回调函数，该函数接受三个参数，分别是发生的错误、标准输出的显示结果、标准错误的显示结果。</p>
<p>由于标准输出和标准错误都是流对象（stream），可以监听data事件，因此上面的代码也可以写成下面这样。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> exec = <span class="built_in">require</span>(<span class="string">'child_process'</span>).exec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> child = exec(<span class="string">'ls -l'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">child.stdout.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'stdout: '</span> + data);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">child.stderr.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'stdout: '</span> + data);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">child.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">code</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'closing code: '</span> + code);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<p>上面的代码还表明，子进程本身有<code>close</code>事件，可以设置回调函数。</p>
<p>上面的代码还有一个好处。监听data事件以后，可以实时输出结果，否则只有等到子进程结束，才会输出结果。所以，如果子进程运行时间较长，或者是持续运行，第二种写法更好。</p>
<p>下面是另一个例子，假定有一个child.js文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// child.js</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> exec = <span class="built_in">require</span>(<span class="string">'child_process'</span>).exec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">exec(<span class="string">'node -v'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error, stdout, stderr</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'stdout: '</span> + stdout);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'stderr: '</span> + stderr);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (error !== <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">console</span>.log(<span class="string">'exec error: '</span> + error);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<p>运行后，该文件的输出结果如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">$ node child.js</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">stdout: v0.11.14</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">stderr:</span></pre></td></tr></table></figure>

<p>exec方法会直接调用bash（<code>/bin/sh</code>程序）来解释命令，所以如果有用户输入的参数，exec方法是不安全的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="string">";user input"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">child_process.exec(<span class="string">'ls -l '</span> + path, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(data);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<p>上面代码表示，在bash环境下，<code>ls -l; user input</code>会直接运行。如果用户输入恶意代码，将会带来安全风险。因此，在有用户输入的情况下，最好不使用<code>exec</code>方法，而是使用<code>execFile</code>方法。</p>
<h2 id="execSync"><a href="#execSync" class="headerlink" title="execSync()"></a>execSync()</h2><p><code>execSync</code>是<code>exec</code>的同步执行版本。</p>
<p>它可以接受两个参数，第一个参数是所要执行的命令，第二个参数用来配置执行环境。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> execSync = <span class="built_in">require</span>(<span class="string">"child_process"</span>).execSync;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> SEPARATOR = process.platform === <span class="string">'win32'</span> ? <span class="string">';'</span> : <span class="string">':'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> env = <span class="built_in">Object</span>.assign(&#123;&#125;, process.env);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">env.PATH = path.resolve(<span class="string">'./node_modules/.bin'</span>) + SEPARATOR + env.PATH;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myExecSync</span>(<span class="params">cmd</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">var</span> output = execSync(cmd, &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    cwd: process.cwd(),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    env: env</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(output);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">myExecSync(<span class="string">'eslint .'</span>);</span></pre></td></tr></table></figure>

<p>上面代码中，<code>execSync</code>方法的第二个参数是一个对象。该对象的<code>cwd</code>属性指定脚本的当前目录，<code>env</code>属性指定环境变量。上面代码将<code>./node_modules/.bin</code>目录，存入<code>$PATH</code>变量。这样就可以不加路径，引用项目内部的模块命令了，比如<code>eslint</code>命令实际执行的是<code>./node_modules/.bin/eslint</code>。</p>
<h2 id="execFile"><a href="#execFile" class="headerlink" title="execFile()"></a>execFile()</h2><p>execFile方法直接执行特定的程序，参数作为数组传入，不会被bash解释，因此具有较高的安全性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> child_process = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="string">"."</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">child_process.execFile(<span class="string">'/bin/ls'</span>, [<span class="string">'-l'</span>, path], <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">console</span>.log(result)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<p>上面代码中，假定<code>path</code>来自用户输入，如果其中包含了分号或反引号，ls程序不理解它们的含义，因此也就得不到运行结果，安全性就得到了提高。</p>
<h2 id="spawn"><a href="#spawn" class="headerlink" title="spawn()"></a>spawn()</h2><p>spawn方法创建一个子进程来执行特定命令，用法与execFile方法类似，但是没有回调函数，只能通过监听事件，来获取运行结果。它属于异步执行，适用于子进程长时间运行的情况。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> child_process = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="string">'.'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ls = child_process.spawn(<span class="string">'/bin/ls'</span>, [<span class="string">'-l'</span>, path]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">ls.stdout.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'stdout: '</span> + data);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">ls.stderr.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'stderr: '</span> + data);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">ls.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">code</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'child process exited with code '</span> + code);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<p>spawn方法接受两个参数，第一个是可执行文件，第二个是参数数组。</p>
<p>spawn对象返回一个对象，代表子进程。该对象部署了EventEmitter接口，它的<code>data</code>事件可以监听，从而得到子进程的输出结果。</p>
<p>spawn方法与exec方法非常类似，只是使用格式略有区别。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">child_process.exec(command, [options], callback)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">child_process.spawn(command, [args], [options])</span></pre></td></tr></table></figure>

<h2 id="fork"><a href="#fork" class="headerlink" title="fork()"></a>fork()</h2><p>fork方法直接创建一个子进程，执行Node脚本，<code>fork(&#39;./child.js&#39;)</code> 相当于 <code>spawn(&#39;node&#39;, [&#39;./child.js&#39;])</code> 。与spawn方法不同的是，fork会在父进程与子进程之间，建立一个通信管道，用于进程之间的通信。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> n = child_process.fork(<span class="string">'./child.js'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">n.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">m</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'PARENT got message:'</span>, m);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">n.send(&#123; <span class="attr">hello</span>: <span class="string">'world'</span> &#125;);</span></pre></td></tr></table></figure>

<p>上面代码中，fork方法返回一个代表进程间通信管道的对象，对该对象可以监听message事件，用来获取子进程返回的信息，也可以向子进程发送信息。</p>
<p>child.js脚本的内容如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">process.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">m</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'CHILD got message:'</span>, m);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">process.send(&#123; <span class="attr">foo</span>: <span class="string">'bar'</span> &#125;);</span></pre></td></tr></table></figure>

<p>上面代码中，子进程监听message事件，并向父进程发送信息。</p>
<h2 id="send"><a href="#send" class="headerlink" title="send()"></a>send()</h2><p>使用 child_process.fork() 生成新进程之后，就可以用 child.send(message, [sendHandle]) 向新进程发送消息。新进程中通过监听message事件，来获取消息。</p>
<p>下面的例子是主进程的代码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cp = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> n = cp.fork(__dirname + <span class="string">'/sub.js'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">n.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">m</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'PARENT got message:'</span>, m);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">n.send(&#123; <span class="attr">hello</span>: <span class="string">'world'</span> &#125;);</span></pre></td></tr></table></figure>

<p>下面是子进程sub.js代码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">process.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">m</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(<span class="string">'CHILD got message:'</span>, m);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">process.send(&#123; <span class="attr">foo</span>: <span class="string">'bar'</span> &#125;);</span></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li>Lift Security Team, <a href="https://blog.liftsecurity.io/2014/08/19/Avoid-Command-Injection-Node.js" target="_blank" rel="noopener">Avoiding Command Injection in Node.js</a>: 为什么execFile()的安全性高于exec()</li>
<li>Krasimir Tsonev, <a href="http://tech.pro/tutorial/2074/nodejs-managing-child-processes" target="_blank" rel="noopener">Node.js: managing child processes</a> </li>
<li>byvoid, <a href="https://www.byvoid.com/zhs/blog/node-child-process-ipc" target="_blank" rel="noopener">Node.js中的child_process及进程通信</a>: exec()、execFile()、fork()、spawn()四种方法的简介</li>
</ul>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-04-14 </div>
			<div class="article-title"><a href="/2017/04/14/2017-04-14-node-js-error/" >Error 对象</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Node的异步操作的特性，使得抛出（<code>throw</code>）错误不可行，因为捕捉错误的代码可能已经执行完毕，无法再捕捉错误了。这时，唯一的办法就是将<code>Error</code>对象传给下一个回调函数。</p>
<p>Express的错误中间件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.error(err.stack);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 401, 403, 404 错误不发邮件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (!err.statusCode || err.statusCode === <span class="number">500</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    emails.error(&#123; <span class="attr">err</span>: err, <span class="attr">req</span>: req &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  res.send(err.statusCode || <span class="number">500</span>, err.message);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<h2 id="自定义错误"><a href="#自定义错误" class="headerlink" title="自定义错误"></a>自定义错误</h2><p>可以用下面的方法，自定义自己的错误对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NotFound</span>(<span class="params">message</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">Error</span>.call(<span class="keyword">this</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">this</span>.message = message;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">util.inherits(NotFound, <span class="built_in">Error</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> error = <span class="keyword">new</span> NotFound(<span class="string">'/home 没有找到'</span>);</span></pre></td></tr></table></figure>

<p>上面代码中，<code>error</code>同时是<code>NotFound</code>和<code>Error</code>的实例。</p>
<h2 id="stack属性"><a href="#stack属性" class="headerlink" title="stack属性"></a>stack属性</h2><p>ECMAScript规格只规定，Error对象的实例必须有<code>message</code>属性，但是各个JavaScript实现往往还添加了堆栈信息。</p>
<ul>
<li>V8引擎是<code>error.stack</code></li>
<li>Firefox也是<code>error.stack</code>，但有自己的格式</li>
<li>IE不提供<code>stack</code>属性</li>
</ul>
<p>以下介绍V8引擎的API，它在Node和Chrome浏览器之中可以使用。</p>
<h2 id="Error-stackTraceLimit"><a href="#Error-stackTraceLimit" class="headerlink" title="Error.stackTraceLimit"></a>Error.stackTraceLimit</h2><p>V8默认将调用堆栈限制在10条记录，但是可以在运行时，通过改变<code>Error.stackTraceLimit</code>属性调整这个值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span>.stackTraceLimit = <span class="number">0</span>; <span class="comment">// 不显示任何堆栈</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span>.stackTraceLimit = <span class="literal">Infinity</span>; <span class="comment">// 堆栈数目不存在任何限制</span></span></pre></td></tr></table></figure>

<h2 id="Error-captureStackTrace"><a href="#Error-captureStackTrace" class="headerlink" title="Error.captureStackTrace()"></a>Error.captureStackTrace()</h2><p><code>Error.captureStackTrace</code>方法用来在指定对象上，为<code>stack</code>属性设立一个取值器（getter），返回<code>Error.captureStackTrace</code>方法运行时的堆栈。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myObject = &#123;&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span>.captureStackTrace(myObject);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">myObject.stack <span class="comment">// 返回代码调用堆栈</span></span></pre></td></tr></table></figure>

<p>上面方法的第二行在<code>myObject</code>对象上，新建一个<code>stack</code>属性，值等于这时<code>Error.captureStackTrace</code>的调用堆栈。</p>
<p><code>Error.captureStackTrace</code>还可以接受第二个参数，是一个处在调用堆栈上的函数。它的作用是将堆栈上，这个函数及其以上的调用记录都隐藏起来不显示。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createError</span>(<span class="params">msg, status</span>)</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(msg);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  err.status = status;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">Error</span>.captureStackTrace(err);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> err;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> err = createError(<span class="string">'test'</span>, <span class="number">500</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> err;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Error: test</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//     at createError (/home/admin/x.js:6:9)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//     at Object.&lt;anonymous&gt; (/home/admin/x.js:10:11)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//     at Module._compile (module.js:409:26)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//     ...</span></span></pre></td></tr></table></figure>

<p>上面代码中，堆栈信息最上面一行会显示<code>createError</code>，表示这个错误是在执行<code>createError</code>函数时产生的。现在，为<code>Error.captureStackTrace</code>方法加入第二个参数<code>createError</code>，就可以把这一行隐藏。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createError</span>(<span class="params">msg, status</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(msg);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  err.status = status;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">Error</span>.captureStackTrace(err, createError);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> err;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> err = createError(<span class="string">'test'</span>, <span class="number">500</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> err;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Error: test</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//     at Object.&lt;anonymous&gt; (/home/admin/x.js:10:11)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//     at Module._compile (module.js:409:26)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//     ...</span></span></pre></td></tr></table></figure>

<p>这个错误通常用于自定义错误。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NotFound</span>(<span class="params">message</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">Error</span>.call(<span class="keyword">this</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">Error</span>.captureStackTrace(<span class="keyword">this</span>, NotFound);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">this</span>.message = message;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">this</span>.statusCode = <span class="number">404</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>上面代码定义了一个<code>NotFound</code>对象，它继承了<code>Error</code>对象。需要的时候，就可以抛出这个对象的实例。</p>
<h2 id="Error-prepareStackTrace"><a href="#Error-prepareStackTrace" class="headerlink" title="Error.prepareStackTrace()"></a>Error.prepareStackTrace()</h2><p><code>Error.prepareStackTrace</code>方法的作用是，定制<code>err.stack</code>的返回值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">Error</span>.prepareStackTrace = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="string">'MyStackObject'</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">console</span>.log(e.stack);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// "MyStackObject"</span></span></pre></td></tr></table></figure>

<p>上面代码定制<code>err.stack</code>返回一个字符串<code>MyStackObject</code>。</p>
<p><code>Error.prepareStackTrace</code>方法可以接受两个参数，第一个是错误对象实例，第二个是表示堆栈的数组，它的每个成员都是一个堆栈记录对象，有一些方法可以在这个对象上调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span> (<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  b();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span> (<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">Error</span>.prepareStackTrace = <span class="function"><span class="keyword">function</span> (<span class="params">err, stack</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> stack;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  &#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">Error</span>.captureStackTrace(err, b);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  err.stack.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">frame</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">console</span>.error(<span class="string">' call: %s:%d - %s'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">      , frame.getFileName()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">      , frame.getLineNumber()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">      , frame.getFunctionName());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">  &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">a();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  call: /home/admin/x.js:2 - a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  call: /home/admin/x.js:22 - null</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  call: module.js:409 - Module._compile</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  call: module.js:416 - Module._extensions..js</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  call: module.js:343 - Module.load</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  call: module.js:300 - Module._load</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  call: module.js:441 - Module.runMain</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  call: node.js:139 - startup</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//  call: node.js:968 - null</span></span></pre></td></tr></table></figure>

<p>上面代码中，<code>Error.prepareStackTrace</code>方法定制了<code>err.stack</code>，返回一个数组。该数组的每个成员都有<code>getFileName()</code>、<code>getLineNumber()</code>、<code>getFunctionName()</code>等方法，可以用来获取文件名、行号、函数名。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li>Guillermo Rauch, <a href="http://www.devthought.com/2011/12/22/a-string-is-not-an-error/" target="_blank" rel="noopener">A String is not an Error</a></li>
</ul>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-03-28 </div>
			<div class="article-title"><a href="/2017/03/28/2017-03-28-yarn-vs-npm/" >yarn vs npm</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>Facebook、Google、Exponent 和 Tilde 联合推出了一个新的 JS 包管理工具 — Yarn，正如<a href="https://link.zhihu.com/?target=https%3A//code.facebook.com/posts/1840075619545360">官方文档__</a>中写的，<strong>Yarn 是为了弥补 npm 的一些缺陷而出现的</strong>：</p>
<ol>
<li><p>npm 安装包（packages）的速度不够快，拉取的 packages 可能版本不同</p>
</li>
<li><p>npm 允许在安装 packages 时执行代码，这就埋下了安全隐患<br>别慌，Yarn 没想要完全替代 npm，它只是一个新的 CLI 工具，拉取的 packages 依然来自 npm 仓库。仓库本身不会变，所以获取或者发布模块的时候和原来一样。  </p>
</li>
</ol>
<p>那么，是不是所有人都要尽快搭上 Yarn 的车呢？取决于你在使用 npm 时有没有遇到不可忍受的痛点。接下来，我们将会对比 npm 和 Yarn，看完之后，相信你就有了答案。  </p>
<h2 id="二、Yarn-vs-npm：特性差异"><a href="#二、Yarn-vs-npm：特性差异" class="headerlink" title="二、Yarn vs npm：特性差异"></a>二、Yarn vs npm：特性差异</h2><p>第一眼看到 Yarn，估计会觉得和 npm 也太像了吧。不过进一步了解 Yarn 之后，我们会发现它的特别之处。  </p>
<h3 id="2-1-yarn-lock-文件"><a href="#2-1-yarn-lock-文件" class="headerlink" title="2.1 yarn.lock 文件"></a>2.1 <strong>yarn.lock 文件</strong></h3><p>npm 和 Yarn 都是通过 package.json 记录项目需要拉取的依赖模块，不过在使用时，往往 package.json 中模块的版本号不太会写得非常确切，通常是定个<strong>版本范围</strong>。这样你就能自行选择使用模块的大版本或者小版本，也允许 npm 拉取模块最新的修复了 bug 的版本。  </p>
<p>在理想的 <a href="https://link.zhihu.com/?target=http%3A//semver.org/lang/zh-CN/">语义化版本__</a>世界中，新版是不会有颠覆旧版本的改变，然而现实并非如此。这就导致了使用 npm 拉取依赖时，<strong>即使用的是相同的 package.json，在不同的设备上拉到的 packages 版本不一，这就可能为项目引入 bug</strong>。  </p>
<p>为了防止拉取到不同的版本，Yarn 有一个锁定文件 (lock file) 记录了被确切安装上的模块的版本号。每次只要新增了一个模块，Yarn 就会创建（或更新）yarn.lock 这个文件。这么做就保证了，每一次拉取同一个项目依赖时，使用的都是一样的模块版本。  </p>
<p>npm 其实也有办法实现处处使用相同版本的 packages，但需要开发者执行 npm shrinkwrap 命令。这个命令将会生成一个锁定文件，在执行 npm install 的时候，该锁定文件会先被读取，和 Yarn 读取 yarn.lock 文件一个道理。npm 和 Yarn 两者的不同之处在于，Yarn 默认会生成这样的锁定文件，而 npm 要通过 shrinkwrap 命令生成 npm-shrinkwrap.json 文件，只有当这个文件存在的时候，packages 版本信息才会被记录和更新。    </p>
<h3 id="2-2-并行安装"><a href="#2-2-并行安装" class="headerlink" title="2.2 并行安装"></a>2.2 <strong>并行安装</strong></h3><p>无论 npm 还是 Yarn 在执行包的安装时，都会执行一系列任务。npm 是按照队列执行每个 package，也就是说必须要等到当前 package 成功安装之后，才能继续后面的安装。而 Yarn 是同步执行所有任务，提高了性能。  </p>
<p>通过拉取 <a href="https://link.zhihu.com/?target=https%3A//www.npmjs.com/package/express">express__</a> 依赖，我比较了 npm 和 Yarn 的效率，在没有用任何锁定文件（也就是没有缓存）的前提下，一共安装 42 个依赖：</p>
<ol>
<li><p>npm 耗时 9 秒</p>
</li>
<li><p>Yarn 耗时 1.37 秒</p>
</li>
</ol>
<p>这耗时……我没法相信自己的眼睛了，反复尝试几次，得到的结果也差不多。于是我又试着安装了有195个依赖的 <a href="https://link.zhihu.com/?target=https%3A//www.npmjs.com/package/gulp">gulp__</a>，这一次：  </p>
<ol>
<li><p>npm 耗时 11 秒</p>
</li>
<li><p>Yarn 耗时 7.81 秒</p>
</li>
</ol>
<p>看来 npm 和 Yarn 在安装包的速度差异和要安装的包个数强相关，不过不管怎么样，Yarn 都比 npm 要快。  </p>
<h3 id="2-3-更简洁的输出"><a href="#2-3-更简洁的输出" class="headerlink" title="2.3 更简洁的输出"></a>2.3 <strong>更简洁的输出</strong></h3><p>npm 的输出信息比较冗长。在执行 npm install <package> 的时候，命令行里会不断地打印出所有被安装上的依赖。相比之下，Yarn 简洁太多：默认情况下，结合了 emoji （Windows 上 emoji 不可见）直观且直接地打印出必要的信息，也提供了一些命令供开发者查询额外的安装信息。  <img src="https://pic1.zhimg.com/v2-5f6f31df2f1be755ace92ba2908cfe34_b.png" alt=""></p>
<h2 id="三、CLI-区别"><a href="#三、CLI-区别" class="headerlink" title="三、CLI 区别"></a>三、CLI 区别</h2><p>除了特性上的区别，相比于 npm 的命令，Yarn 命令有增有减还有一些更改。  </p>
<h3 id="3-1-yarn-global"><a href="#3-1-yarn-global" class="headerlink" title="3.1 yarn global"></a>3.1 <strong>yarn global</strong></h3><p>npm 的全局操作命令要加上 -g 或者 –global 参数，Yarn 的全局命令则需要加上 global。和 npm 类似，项目特定的依赖，就不需要全局安装了。</p>
<p>当执行 yarn add、yarn bin、yarn ls 和 yarn remove 时添加 global 前缀才是有全局作用。除了 yarn add 之外，其他三个命令和 npm 的一样。</p>
<h3 id="3-2-yarn-install"><a href="#3-2-yarn-install" class="headerlink" title="3.2 yarn install"></a>3.2 <strong>yarn install</strong></h3><p>npm install 命令安装的是 package.json 中的依赖，如果开发者在 package.json 中添加了新的依赖，npm install 也一样安装。然而，yarn install 会优先安装 yarn.lock 中记录的依赖，没有这样的锁定文件时，才会去安装 package.json 中的依赖。</p>
<h3 id="3-3-yarn-add-–dev"><a href="#3-3-yarn-add-–dev" class="headerlink" title="3.3 yarn add [–dev]"></a>3.3 <strong>yarn add [–dev]</strong></h3><p>和 npm install 类似，yarn add 命令允许你添加并安装依赖。通过这个命令添加的依赖都会被自动加到 package.json 中，和我们在 npm 命令中使用 –save 参数一样。Yarn 的-dev 则等同于 npm 的 –save-dev。</p>
<h3 id="3-4-yarn-licenses-ls-generate-disclaimer"><a href="#3-4-yarn-licenses-ls-generate-disclaimer" class="headerlink" title="3.4 yarn licenses [ls|generate-disclaimer]"></a>3.4 <strong>yarn licenses [ls|generate-disclaimer]</strong></h3><p>在写这篇文章的时候，npm 没有等同的命令。yarn licenses ls 用于罗列出所有被安装的 package 所持有的执照情况。yarn licenses generate-disclaimer 将生成一个对所有依赖的免责声明。有些执照要求开发者一定要在项目中包含这些它们，这个命令就是为这样的场景存在的。</p>
<h3 id="3-5-yarn-why"><a href="#3-5-yarn-why" class="headerlink" title="3.5 yarn why"></a>3.5 <strong>yarn why</strong></h3><p>这条命令能帮助开发者理清安装的 package 之间的关系。拉取了各种依赖以后，有些 package 是你显式安装的，有些包则是递归依赖的。</p>
<h3 id="3-6-yarn-upgrade-package"><a href="#3-6-yarn-upgrade-package" class="headerlink" title="3.6 yarn upgrade [package]"></a>3.6 <strong>yarn upgrade [package]</strong></h3><p>这条命令将根据 package.json 将 package 升级到最新版本，并更新 yarn.lock，和 npm update 相似。  </p>
<p>有意思的是，如果指定了 [package] 参数，Yarn 会将 package 升级到最新版本，并更新 package.json 中该 package 的版本号字段。</p>
<h3 id="3-7-yarn-generate-lock-entry"><a href="#3-7-yarn-generate-lock-entry" class="headerlink" title="3.7 yarn generate-lock-entry"></a>3.7 <strong>yarn generate-lock-entry</strong></h3><p>这条命令将会生成一份基于 package.json 的 yarn.lock 文件，作用和 npm shrinkwrap 类似。不过由于执行 yarn add andyarn upgrade 时都会更新 yarn.lock 文件，所以要慎重执行 yarn generate-lock-entry 命令</p>
<h2 id="四、稳定性和可依赖度"><a href="#四、稳定性和可依赖度" class="headerlink" title="四、稳定性和可依赖度"></a>四、稳定性和可依赖度</h2><p>看到 Yarn 刚发布时长长的 <a href="https://link.zhihu.com/?target=https%3A//github.com/yarnpkg/yarn/issues">issue 列表__</a>，真的很担心上了一辆灵车…但大家也可以看到问题解决的速度之快，令人震惊。可以感受到 Yarn 社区确实在攻克 bug，从问题列表上也能发现 Yarn 大部分 bug 发生在边界情况下，其实对于大多数开发者而言，Yarn 已经足够稳定了。  </p>
<p>虽然现在包管理工具在一个项目中扮演着不可或缺的角色，但它仅仅是个包管理工具。如果拉取的依赖出了问题，大可以重新拉取或者干脆用 npm 再安装看看。  </p>
<h2 id="五、未来"><a href="#五、未来" class="headerlink" title="五、未来"></a>五、未来</h2><p>可能你想到了 Node.js 和 io.js 的爱恨情仇：io.js 源自 Node.js 的一个分支，它的领导者是原来 Node.js 的一些核心开发者，几位核心开发者和 Node.js 的管理者产生了一些分歧，所以开启了一个新的分支，不同于 Node.js，io.js 采用的是开放管理。不过一年不到，io.js 又合并回 Node.js 中，开发者们也不再更新 io.js。不去评论 io.js 的出走是对是错，我们知道的是现在 Node.js 有了更多非常好的特性。  </p>
<p>在 npm 和 Yarn 上我看到了当初 Node 和 io 的影子，虽然 Yarn 之于 npm 并不是分支之于主干的关系，但它确实弥补了 npm 的一些缺陷。如果 npm 能邀请 Facebook、Google 以及其他的 Yarn 社区推动者一同来改进 npm 不是很好吗？虽然现在提这个为时尚早，但我真心希望 npm 能这么做。  </p>
<p>现在看起来，Yarn 的未来一片光明。开发者们很期待这个新工具，也认可它作为一个包管理工具的能力。不过 Yarn 发展方向并没有很明确，我也不确定将会有什么新的特性。  </p>
<h2 id="六、结论"><a href="#六、结论" class="headerlink" title="六、结论"></a>六、结论</h2><p>目前看来 Yarn 要比 npm 更好用：默认就有锁定文件、更快速地安装依赖以及依赖的更新会自动同步到 package.json 文件中。从 npm 迁移到 Yarn 成本几乎为零，你大可以在一个项目里用用看，感受下它是否适合你。以上优点都让 Yarn 成为了目前 npm 最好的替代品。  </p>
<p>我非常鼓励大家尽快在项目中用起 Yarn。不过如果你是一个对新工具相当谨慎的人，也可以等多两三个月再去尝试。毕竟 npm 才是久经沙场的老将。  </p>
<p>如果你发现自己花费在等待 npm 安装依赖上的时间实在太久了，那是时候试试看 Yarn 了，不如先从<a href="https://link.zhihu.com/?target=https%3A//yarnpkg.com/en/docs/migrating-from-npm">迁移文档__</a>开始吧。  </p>
<p>你对 Yarn 怎么看的？是不是已经用起了 Yarn？还是尚未使用但已经想试试看了？又或者觉得 Yarn 只是历史进程中的一步？在<a href="https://link.zhihu.com/?target=https%3A//www.sitepoint.com/yarn-vs-npm/">这篇文章__</a>下留言吧，让我们一起来讨论 Yarn。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/23493436" target="_blank" rel="noopener">引用</a></li>
<li><a href="https://www.sitepoint.com/yarn-vs-npm/" target="_blank" rel="noopener">原文</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//yarnpkg.com/en/docs/cli/install">yarn install 文档</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//docs.npmjs.com/cli/install">npm install 文档</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//yarnpkg.com/en/docs/cli/generate-lock-entry">yarn generate-lock-entry 文档</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//docs.npmjs.com/cli/shrinkwrap">npm shrinkwrap 文档</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//yarnpkg.com/en/docs/cli/upgrade">yarn upgrade 文档</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//yarnpkg.com/en/docs/cli/licenses">yarn licenses 文档</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//yarnpkg.com/en/docs/cli/why">yarn why 文档</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//yarnpkg.com/en/docs/cli/global">yarn global 文档</a></li>
<li>慕课网视频: <a href="http://www.imooc.com/learn/766" target="_blank" rel="noopener">Yarn构建工具入门基础</a></li>
</ul>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-03-25 </div>
			<div class="article-title"><a href="/2017/03/25/2017-03-25-网页中的-icon-图标/" >网页中的 Icon 图标显示方法介绍</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>本文主要是介绍在网页显示图标的几种方式</p>
<h2 id="一、直接引用"><a href="#一、直接引用" class="headerlink" title="一、直接引用"></a>一、直接引用</h2><p>这种方式就是方法简单直观，但是每次都会发起 HTTP 请求，效率不高，影响性能。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">// ...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"../../img/xxx.png/jpg/gif/svg"</span>&gt;</span><span class="tag">&lt;/<span class="name">img</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">// ...</span></pre></td></tr></table></figure>

<h2 id="二、CSS-Sprites"><a href="#二、CSS-Sprites" class="headerlink" title="二、CSS Sprites"></a>二、CSS Sprites</h2><p>在国内很多人叫 Css 精灵，是一种网页图片应用处理方式。它允许你将一个页面涉及到的所有零星图片都包含到一张大图中去，再利用 CSS 的 <code>background-image</code>，<code>background-repeat</code>，<code>background-position</code> 的组合进行背景定位，<code>background-position</code> 可以用数字精确的定位出背景图片的位置。这样一来，当访问该页面时，载入的图片就不会像以前那样一幅一幅地慢慢显示出来了。对于当前网络流行的速度而言，不高于 200KB 的单张图片的所需载入时间基本是差不多的，所以无需顾忌这个问题。<br>这里需要注意的，在使用 <code>background-position</code> 时，使用的 x、y 的坐标都是相对与左上角 (0，0),来计算。所以要显示图片，坐标值都是 <strong>负数</strong>。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="css"><span class="selector-class">.sprite</span> <span class="selector-tag">span</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	height: 40px;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	width: 24px;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	display: block;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">	margin-left: 10px;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	margin-right: 8px;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">	float: left;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	background-image: url("../images/my-icon.png");</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="css"><span class="selector-class">.sprite</span> <span class="selector-tag">span</span><span class="selector-pseudo">:hover</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="css">	<span class="selector-tag">background-color</span>: <span class="selector-id">#fff</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="css">	<span class="selector-tag">border-color</span>: <span class="selector-id">#fff</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="css"><span class="selector-class">.sprite</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="css">	<span class="selector-tag">color</span>: <span class="selector-id">#b51600</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="css"><span class="selector-class">.icon-music</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">	background-position: 0 -40;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"sprite"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"background-position: 0 -40;"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>图片显示在我前面<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">// 或者</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"sprite"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-music"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>图片显示在我前面<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr></table></figure>

<h2 id="三、字体图标方式"><a href="#三、字体图标方式" class="headerlink" title="三、字体图标方式"></a>三、字体图标方式</h2><p>利用字体工具把我们平时 Web 上用的图形图标（icons）转换成 web fonts，就成了 icon fonts，它可以借助 CSS 的 @font-face 嵌入到网页里，用以显示 icons。因为字体是矢量化图形，它天生具有「分辨率无关」的特性，在任何分辨率和PPI下面，都可以做到完美缩放，不会像传统位图，如：png，jpeg，放大后有锯齿或模糊现象。<br>使用字体图标库和上面的 <code>css sprite</code> 一样可以避免发起多次 <code>HTTP</code> 请求的性能损耗问题，更重要的是，它是矢量图，放大不会失真，而且还可以改变它的颜色和添加动画，还有浏览器的兼容性也非常好。它在 <code>Web</code> 中的实现有下面三种方式。<br>下面的代码已经默认把我们要生成的图标转为字体文件，具体方法很多，简单方法可以通过在线生成。这里介绍个国外的网站 <a href="https://icomoon.io" target="_blank" rel="noopener">icomoon(图标在线生成工具)</a>，大部分都是免费的。<br>生成的字体文件的四种格式：</p>
<ul>
<li>my-icon.eot</li>
<li>my-icon.woff</li>
<li>my-icon.ttf</li>
<li>my-icon.svg<br>上面的字体格式说明如果不清楚可以参考 <a href="/2016/09/04/网页字体替换/">网页字体替换</a> </li>
</ul>
<h3 id="1-font-html"><a href="#1-font-html" class="headerlink" title="1. font + html"></a>1. font + html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="css">@<span class="keyword">font-face</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  font-family: "my-icon";</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  src: url("../fonts/my-icon.eot");</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="css">  <span class="comment">/* 添加: ? 是为了IE9 兼容模式，而 '#iefix' 是注释意思 */</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  src: url("../fonts/my-icon.eot?#iefix") format("embedded-opentype"), </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  url("../fonts/my-icon.woff") format("woff"), </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  url("../fonts/my-icon.ttf") format("truetype"), </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  url("../fonts/my-icon.svg") format("svg");</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  font-weight: normal;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  font-style: normal;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="css"><span class="selector-class">.my-icon</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  font-family: "my-icon";</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  font-style: normal;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">  font-weight: normal;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">  font-size: 64px;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="css">  <span class="comment">/*可以让如表更好的显示*/</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">  -webkit-font-smoothing: antialiased;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">  -moz-osx-font-smoothing: grayscale;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">&lt;!-- 可以重新设置图标显示的颜色和大小 --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">i</span> <span class="attr">style</span>=<span class="string">"color: #efe0ce;font-size:30px;"</span> <span class="attr">class</span>=<span class="string">"my-icon"</span>&gt;</span>&amp;#xf048;<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></pre></td></tr></table></figure>
<p>上面中显示的图标是通过字体中对应的 16 进制值来显示：<code>f048;</code>。在网页中要显示 16 进制值需要添加 <code>&amp;#x</code> 前缀。</p>
<h3 id="2-font-css"><a href="#2-font-css" class="headerlink" title="2. font + css"></a>2. font + css</h3><h4 id="2-1-方式一"><a href="#2-1-方式一" class="headerlink" title="2.1 方式一"></a>2.1 方式一</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">// ... 代码同上</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="css"><span class="selector-class">.icon-music</span><span class="selector-pseudo">:before</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="css">	<span class="selector-tag">content</span>: "\<span class="selector-tag">f048</span>"; <span class="comment">/*前面的 `\` 是转义字符。*/</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"my-icon icon-music"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></pre></td></tr></table></figure>

<h4 id="2-2-方式二"><a href="#2-2-方式二" class="headerlink" title="2.2 方式二"></a>2.2 方式二</h4><p>上面 2.1 的方式唯一麻烦的是要一个一个的去写样式文件，肯定不是高效率的方法，有没有自动生成字体的同时把样式都一起写好？答案是肯定的，方法之一就是通过上面介绍的 <a href="https://icomoon.io" target="_blank" rel="noopener">icomoon(图标在线生成工具)</a> 网站生成。</p>
<h4 id="2-3-优点"><a href="#2-3-优点" class="headerlink" title="2.3 优点"></a>2.3 优点</h4><ul>
<li>文件小：相比图片几十几百KB的容量，icon fonts 几乎是羽翼级轻量。</li>
<li>加载性能好：因为图标都被打包进一套字体内，http request 减少。这如同我们常用的 css sprites 技术。</li>
<li>支持CSS样式：和普通字体一样，你可以利用CSS来定义大小、颜色、阴影、hover状态、透明度、渐变等等…</li>
<li>兼容性好：web fonts 起源很早，别说主流浏览器，连IE6/7都能良好支持。除了一些老的移动端浏览器，如Android 2.1以下的初代浏览器，Opera mini 这类自限型浏览器。</li>
</ul>
<h4 id="2-4-不足点"><a href="#2-4-不足点" class="headerlink" title="2.4 不足点"></a>2.4 不足点</h4><ul>
<li>样式单一，无法针对不同分辨率来调整icon 的细节，比如降低大尺寸icon 的线条粗细。</li>
<li>颜色单一，CSS 无法方便的去定义彩色的 icon，倒是有通过叠加组合的方式来达到彩色图标的目的。</li>
<li>移动端浏览器兼容性还不够完善，像Opera mini、Windows phone 7.0-7.8 都不能正常显示icon fonts。</li>
<li>有少量的移动设备有可能会和 icon fonts 的字符编码冲突，导致icon 显示不正常.</li>
</ul>
<h2 id="四、各种显示方式对比"><a href="#四、各种显示方式对比" class="headerlink" title="四、各种显示方式对比"></a>四、各种显示方式对比</h2><p><img src="" alt=""></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://baike.baidu.com/item/css%20sprite?fr=aladdin" target="_blank" rel="noopener">css sprite</a></li>
<li><a href="http://www.infoq.com/cn/articles/icons-fonts-as-your-responsive-strategy" target="_blank" rel="noopener">响应式Web图形篇 —— icon fonts 的探析及应用</a></li>
<li><a href="http://www.w3cplus.com/css3/how-to-turn-your-icons-into-a-web-font.html" target="_blank" rel="noopener">如何把你的图标转换成web字体</a></li>
<li><a href="http://sanwen.net/a/qavwspo.html" target="_blank" rel="noopener">关于SVG与Icon Font的几点比较 | CSS</a></li>
<li>在线图标生成网站<ul>
<li><a href="https://icomoon.io" target="_blank" rel="noopener">icon 图标生成工具</a> 国外网站,可能会比较慢</li>
<li><a href="http://www.iconfont.cn" target="_blank" rel="noopener">阿里的 iconfont</a>    </li>
<li><a href="http://fontello.com/" target="_blank" rel="noopener">fontello</a>  </li>
<li><a href="http://fontawesome.io/" target="_blank" rel="noopener">Font Awesome</a></li>
</ul>
</li>
<li><a href="http://www.w3cplus.com/css3/learning-to-use-the-before-and-after-pseudo-elements-in-css.html" target="_blank" rel="noopener">before 和 after 伪元素</a></li>
<li><a href="http://www.w3cplus.com/css3/css-reference/content.html" target="_blank" rel="noopener">css content</a></li>
<li><a href="http://www.imooc.com/learn/243" target="_blank" rel="noopener">用字体在网页中画ICON图标</a> 慕课网视频教程，推荐</li>
<li><a href="http://blog.csdn.net/xiaoermingn/article/details/53543001" target="_blank" rel="noopener">webpack中如何使用iconfont字体图标</a></li>
<li><a href="http://www.tuicool.com/articles/6zMfIbF" target="_blank" rel="noopener">webpack多页应用架构系列（六）：听说webpack连图片和字体也能打包？</a></li>
</ul>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-03-23 </div>
			<div class="article-title"><a href="/2017/03/23/2017-03-23-javascript-lib-json-server/" >JSON server</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>当我们在开发有前后端通信项目时，常常需要后台数据来调试我们的前端界面。如果后端还未完成，是否有办法快速搭建一个服务器帮助我们 <code>mock</code> 返回后台数据呢？那就赶紧往下看吧！</p>
<h2 id="一、JSON-server"><a href="#一、JSON-server" class="headerlink" title="一、JSON server"></a>一、JSON server</h2><p>JSON server 就是用来快速搭建一个后台数据服务器，它还提供了完整的 REST API，下面是 github 上的介绍</p>
<blockquote>
<p>Get a full fake REST API with zero coding in less than 30 seconds (seriously)</p>
</blockquote>
<h2 id="二、快速开始"><a href="#二、快速开始" class="headerlink" title="二、快速开始"></a>二、快速开始</h2><h3 id="1-下载安装"><a href="#1-下载安装" class="headerlink" title="1. 下载安装"></a>1. 下载安装</h3><p><code>npm install -g json-server</code></p>
<h3 id="2-运行自带的-demo-数据库服务器"><a href="#2-运行自带的-demo-数据库服务器" class="headerlink" title="2. 运行自带的 demo 数据库服务器"></a>2. 运行自带的 <code>demo</code> 数据库服务器</h3><p><code>json-server db.json</code><br>也可以运行自定义的数据库<br><code>json-server your-db.json</code></p>
<p>这时可以通过浏览器打开 <code>http://localhost:3000</code> 查看</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"posts"</span>: [</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"id"</span>: <span class="number">1</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"title"</span>: <span class="string">"json-server"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"author"</span>: <span class="string">"typicode"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  ],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"comments"</span>: [</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"id"</span>: <span class="number">1</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"body"</span>: <span class="string">"some comment"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">      <span class="string">"postId"</span>: <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  ],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">  <span class="string">"profile"</span>: &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="string">"name"</span>: <span class="string">"typicode"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>上面是已经存在的数据</p>
<h3 id="3-REST-API-测试"><a href="#3-REST-API-测试" class="headerlink" title="3. REST API 测试"></a>3. REST API 测试</h3><p>下面的是代码我们使用 <code>axios</code> 库来测试对应的 HTTP 请求，如果不知道 <code>axios</code> 是啥，可以参看下官网 <a href="https://github.com/mzabriskie/axios" target="_blank" rel="noopener">axios</a>;</p>
<h4 id="3-1-GET"><a href="#3-1-GET" class="headerlink" title="3.1 GET"></a>3.1 GET</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">axios.get(<span class="string">'http://localhost:3000/comments/1'</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">.then(<span class="function">(<span class="params">result</span>)=&gt;</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.log(<span class="string">'get-&gt;success: '</span> + <span class="built_in">JSON</span>.stringify(result.data));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	resultEle.value = <span class="built_in">JSON</span>.stringify(result.data);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">.catch(<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.error(<span class="string">'get-&gt;error: '</span> + <span class="built_in">JSON</span>.stringify(err));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#123;"id":1,"body":"some comment","postId":1&#125;</span></span></pre></td></tr></table></figure>
<p>上面请求的路径是 <code>comments/1</code> 对应到上面的数据库中 <code>comments</code> 属性中 <code>id=1</code> 的值。</p>
<h4 id="3-2-POST"><a href="#3-2-POST" class="headerlink" title="3.2 POST"></a>3.2 POST</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">axios.post(<span class="string">'http://localhost:3000/comments'</span>,&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	body: <span class="string">"json server is very great"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	postId: <span class="number">2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">.then(<span class="function">(<span class="params">result</span>)=&gt;</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.log(<span class="string">'post-&gt;success: '</span> + <span class="built_in">JSON</span>.stringify(result.data));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	resultEle.value = <span class="built_in">JSON</span>.stringify(result.data);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">.catch(<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.error(<span class="string">'post-&gt;error: '</span> + <span class="built_in">JSON</span>.stringify(err));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>
<p>// 注意上面的 <code>url</code> 和 <code>get</code> 的区别, <code>post</code> 中只有到 <code>comments</code> 这一级</p>
<h4 id="3-3-put-修改"><a href="#3-3-put-修改" class="headerlink" title="3.3 put(修改)"></a>3.3 put(修改)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">axios.put(<span class="string">'http://localhost:3000/comments'</span>,&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	body: <span class="string">"json server is very great"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	postId: <span class="number">2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">.then(<span class="function">(<span class="params">result</span>)=&gt;</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.log(<span class="string">'put-&gt;success: '</span> + <span class="built_in">JSON</span>.stringify(result.data));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	resultEle.value = <span class="built_in">JSON</span>.stringify(result.data);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">.catch(<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.error(<span class="string">'put-&gt;error: '</span> + <span class="built_in">JSON</span>.stringify(err));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>
<p>同 <code>post</code> 基本一样</p>
<h4 id="3-4-delete"><a href="#3-4-delete" class="headerlink" title="3.4 delete"></a>3.4 delete</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">axios.delete(<span class="string">'http://localhost:3000/comments/2'</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">.then(<span class="function">(<span class="params">result</span>)=&gt;</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.log(<span class="string">'delete-&gt;success: '</span> + <span class="built_in">JSON</span>.stringify(result.statusText));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	resultEle.value = <span class="built_in">JSON</span>.stringify(result.statusText);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">.catch(<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.error(<span class="string">'delete-&gt;error: '</span> + <span class="built_in">JSON</span>.stringify(err));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>
<p>路径同 <code>get</code> 的一样，具体到要删除的某个值</p>
<p>在上面的每次操作完刷新下 <code>http://localhost::3000/db</code> 页面，可以看到每次 HTTP 请求操作结果。</p>
<h4 id="3-5-完整测试代码"><a href="#3-5-完整测试代码" class="headerlink" title="3.5 完整测试代码"></a>3.5 完整测试代码</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>axios demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">h3</span>&gt;</span>结果显示<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"result"</span> <span class="attr">rows</span>=<span class="string">"10"</span> <span class="attr">cols</span>=<span class="string">"50"</span> <span class="attr">readonly</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span> <span class="tag">&lt;<span class="name">br</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 	&lt;h3&gt;输入数据&lt;/h3&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	&lt;textarea id="input" rows="5" cols="50"&gt;&lt;/textarea&gt; --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"get"</span>&gt;</span>get<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"post"</span>&gt;</span>post<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"put"</span>&gt;</span>put<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"delete"</span>&gt;</span>delete<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">	<span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">		<span class="keyword">var</span> resultEle = <span class="built_in">document</span>.getElementById(<span class="string">'result'</span>);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">		<span class="keyword">var</span> inputEle = <span class="built_in">document</span>.getElementById(<span class="string">'input'</span>);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">		<span class="keyword">var</span> getEle = <span class="built_in">document</span>.getElementById(<span class="string">'get'</span>);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">		<span class="keyword">var</span> postEle = <span class="built_in">document</span>.getElementById(<span class="string">'post'</span>);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">		<span class="keyword">var</span> putEle = <span class="built_in">document</span>.getElementById(<span class="string">'put'</span>);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">		<span class="keyword">var</span> deleteEle = <span class="built_in">document</span>.getElementById(<span class="string">'delete'</span>);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">		<span class="comment">// get</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">		getEle.addEventListener(<span class="string">'click'</span>,()=&gt;&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">			axios.get(<span class="string">'http://localhost:3000/comments/1'</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">			.then(<span class="function">(<span class="params">result</span>)=&gt;</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'get-&gt;success: '</span> + <span class="built_in">JSON</span>.stringify(result.data));</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				resultEle.value = <span class="built_in">JSON</span>.stringify(result.data);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">			&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">			.catch(<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				<span class="built_in">console</span>.error(<span class="string">'get-&gt;error: '</span> + <span class="built_in">JSON</span>.stringify(err));</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">			&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">		&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">		<span class="comment">// post</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">		postEle.addEventListener(<span class="string">'click'</span>,()=&gt;&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">			axios.post(<span class="string">'http://localhost:3000/comments'</span>,&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">				body: <span class="string">"json server is very great"</span>,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">      	postId: 2</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">			&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">			.then(<span class="function">(<span class="params">result</span>)=&gt;</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'post-&gt;success: '</span> + <span class="built_in">JSON</span>.stringify(result.data));</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				resultEle.value = <span class="built_in">JSON</span>.stringify(result.data);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">			&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">			.catch(<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				<span class="built_in">console</span>.error(<span class="string">'post-&gt;error: '</span> + <span class="built_in">JSON</span>.stringify(err));</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">			&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">		&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">		<span class="comment">// put</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">		putEle.addEventListener(<span class="string">'click'</span>,()=&gt;&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">			axios.put(<span class="string">'http://localhost:3000/comments/2'</span>,&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">				body: <span class="string">"axios is very useful"</span>,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">      	postId: 2</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">			&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">			.then(<span class="function">(<span class="params">result</span>)=&gt;</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'put-&gt;success: '</span> + <span class="built_in">JSON</span>.stringify(result.data));</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				resultEle.value = <span class="built_in">JSON</span>.stringify(result.data);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">			&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">			.catch(<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				<span class="built_in">console</span>.error(<span class="string">'put-&gt;error: '</span> + <span class="built_in">JSON</span>.stringify(err));</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">			&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">		&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">		<span class="comment">// delete</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">		deleteEle.addEventListener(<span class="string">'click'</span>,()=&gt;&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line"><span class="actionscript">			axios.delete(<span class="string">'http://localhost:3000/comments/2'</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">			.then(<span class="function">(<span class="params">result</span>)=&gt;</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'delete-&gt;success: '</span> + <span class="built_in">JSON</span>.stringify(result.statusText));</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				resultEle.value = <span class="built_in">JSON</span>.stringify(result.statusText);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">			&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">			.catch(<span class="function">(<span class="params">err</span>)=&gt;</span>&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line"><span class="javascript">				<span class="built_in">console</span>.error(<span class="string">'delete-&gt;error: '</span> + <span class="built_in">JSON</span>.stringify(err));</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">			&#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">		&#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/axios/dist/axios.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/typicode/json-server" target="_blank" rel="noopener">json-server</a></li>
</ul>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-03-18 </div>
			<div class="article-title"><a href="/2017/03/18/2017-03-18-document-exec-command/" >execCommand</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>当一个 HTML 文档切换到设计模式(designMode)时，文档对象暴露 <code>execCommand</code> 方法，该方法允许运行命令来操纵可编辑区域的内容。大多数命令影响文档的选择（粗体，斜体等），而其他命令插入新元素（添加链接）或影响整行（缩进）。当使用 <code>contentEditable</code> 时，调用 <code>execCommand()</code> 将影响当前活动的可编辑元素。</p>
<h2 id="二、用法"><a href="#二、用法" class="headerlink" title="二、用法"></a>二、用法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">bool = <span class="built_in">document</span>.execCommand(aCommandName, aShowDefaultUI, aValueArgument)</span></pre></td></tr></table></figure>
<h3 id="1-返回值"><a href="#1-返回值" class="headerlink" title="1. 返回值"></a>1. 返回值</h3><p>一个 <code>Boolean</code> ，如果是 <code>false</code> 则表示操作不被支持或未被启用。</p>
<h3 id="2-参数"><a href="#2-参数" class="headerlink" title="2. 参数"></a>2. 参数</h3><h4 id="2-1-aCommandName"><a href="#2-1-aCommandName" class="headerlink" title="2.1 aCommandName"></a>2.1 aCommandName</h4><p>一个 DOMString ，命令的名称。可用命令列表请参阅 命令 。</p>
<h4 id="2-2-aShowDefaultUI"><a href="#2-2-aShowDefaultUI" class="headerlink" title="2.2 aShowDefaultUI"></a>2.2 aShowDefaultUI</h4><p>一个 Boolean 是否展示用户界面，一般为 false。Mozilla 没有实现。</p>
<h4 id="2-3-aValueArgument"><a href="#2-3-aValueArgument" class="headerlink" title="2.3 aValueArgument"></a>2.3 aValueArgument</h4><p>一些命令需要一些额外的参数值（如insertimage需要提供这个image的url）。默认为null。</p>
<h3 id="3-命令"><a href="#3-命令" class="headerlink" title="3. 命令"></a>3. 命令</h3><h4 id="3-1-backColor"><a href="#3-1-backColor" class="headerlink" title="3.1 backColor"></a>3.1 backColor</h4><p>修改文档的背景颜色。在 <code>styleWithCss</code> 模式下，则只影响容器元素的背景颜色。这需要一个 <code>&lt;color&gt;</code> 类型的字符串值作为参数传入。注意，IE 浏览器用这个设置文字的背景颜色。</p>
<h4 id="3-2-bold"><a href="#3-2-bold" class="headerlink" title="3.2 bold"></a>3.2 bold</h4><p>开启或关闭选中文字或插入点的粗体字效果。IE 浏览器使用 <code>&lt;strong&gt;</code> 标签，而不是 <code>&lt;b&gt;</code> 标签。</p>
<h4 id="3-3-contentReadOnly"><a href="#3-3-contentReadOnly" class="headerlink" title="3.3 contentReadOnly"></a>3.3 contentReadOnly</h4><p>通过传入一个布尔类型的参数来使能文档内容的可编辑性。(IE浏览器不支持)</p>
<h4 id="3-4-copy"><a href="#3-4-copy" class="headerlink" title="3.4 copy"></a>3.4 copy</h4><p>拷贝当前选中内容到剪贴板。启用这个功能的条件因浏览器不同而不同，而且不同时期，其启用条件也不尽相同。使用之前请检查浏览器兼容表，以确定是否可用。</p>
<h4 id="3-5-createLink"><a href="#3-5-createLink" class="headerlink" title="3.5 createLink"></a>3.5 createLink</h4><p>将选中内容创建为一个锚链接。这个命令需要一个 <code>HREF URI</code> 字符串作为参数值传入。URI 必须包含至少一个字符，例如一个空格。（浏览器会创建一个空链接）</p>
<h4 id="3-6-cut"><a href="#3-6-cut" class="headerlink" title="3.6 cut"></a>3.6 cut</h4><p> 剪贴当前选中的文字并复制到剪贴板。启用这个功能的条件因浏览器不同而不同，而且不同时期，其启用条件也不尽相同。使用之前请检查浏览器兼容表，以确定是否可用。</p>
<h4 id="3-7-decreaseFontSize"><a href="#3-7-decreaseFontSize" class="headerlink" title="3.7 decreaseFontSize"></a>3.7 decreaseFontSize</h4><p>给选中文字加上 <code>&lt;small&gt;</code> 标签，或在选中点插入该标签。(IE浏览器不支持)</p>
<h4 id="3-8-delete"><a href="#3-8-delete" class="headerlink" title="3.8 delete"></a>3.8 delete</h4><p>删除选中部分.</p>
<h4 id="3-9-enableInlineTableEditing"><a href="#3-9-enableInlineTableEditing" class="headerlink" title="3.9 enableInlineTableEditing"></a>3.9 enableInlineTableEditing</h4><p>启用或禁用表格行和列插入和删除控件。(IE浏览器不支持)</p>
<h4 id="3-10-enableObjectResizing"><a href="#3-10-enableObjectResizing" class="headerlink" title="3.10 enableObjectResizing"></a>3.10 enableObjectResizing</h4><p>启用或禁用图像和其他对象的大小可调整大小手柄。(IE浏览器不支持)</p>
<h4 id="3-11-fontName"><a href="#3-11-fontName" class="headerlink" title="3.11 fontName"></a>3.11 fontName</h4><p>在插入点或者选中文字部分修改字体名称. 需要提供一个字体名称字符串 (例如：”Arial”)作为参数。</p>
<h4 id="3-12-fontSize"><a href="#3-12-fontSize" class="headerlink" title="3.12 fontSize"></a>3.12 fontSize</h4><p>在插入点或者选中文字部分修改字体大小. 需要提供一个HTML字体尺寸 (1-7) 作为参数。</p>
<h4 id="3-13-foreColor"><a href="#3-13-foreColor" class="headerlink" title="3.13 foreColor"></a>3.13 foreColor</h4><p>在插入点或者选中文字部分修改字体颜色. 需要提供一个颜色值字符串作为参数。</p>
<h4 id="3-14-formatBlock"><a href="#3-14-formatBlock" class="headerlink" title="3.14 formatBlock"></a>3.14 formatBlock</h4><p>添加一个HTML块式标签在包含当前选择的行, 如果已经存在了，更换包含该行的块元素 (在 Firefox中, BLOCKQUOTE 是一个例外 -它将包含任何包含块元素). 需要提供一个标签名称字符串作为参数。几乎所有的块样式标签都可以使用 <code>(例如. &quot;H1&quot;, &quot;P&quot;, &quot;DL&quot;, &quot;BLOCKQUOTE&quot;). (IE浏览器仅仅支持标题标签 H1 - H6, ADDRESS, 和 PRE,使用时还必须包含标签分隔符 &lt; &gt;, 例如 &quot;&lt;H1&gt;&quot;.)</code></p>
<h4 id="3-15-forwardDelete"><a href="#3-15-forwardDelete" class="headerlink" title="3.15 forwardDelete"></a>3.15 forwardDelete</h4><p>删除光标所在位置的字符。 和按下删除键一样。</p>
<h4 id="3-16-heading"><a href="#3-16-heading" class="headerlink" title="3.16 heading"></a>3.16 heading</h4><p>添加一个标题标签在光标处或者所选文字上。 需要提供标签名称字符串作为参数 (例如. “H1”, “H6”). (IE 和 Safari不支持)</p>
<h4 id="3-17-hiliteColor"><a href="#3-17-hiliteColor" class="headerlink" title="3.17 hiliteColor"></a>3.17 hiliteColor</h4><p>更改选择或插入点的背景颜色。需要一个颜色值字符串作为值参数传递。 UseCSS 必须开启此功能。(IE浏览器不支持)</p>
<h4 id="3-18-increaseFontSize"><a href="#3-18-increaseFontSize" class="headerlink" title="3.18 increaseFontSize"></a>3.18 increaseFontSize</h4><p>在选择或插入点周围添加一个BIG标签。(IE浏览器不支持)</p>
<h4 id="3-19-indent"><a href="#3-19-indent" class="headerlink" title="3.19 indent"></a>3.19 indent</h4><p>缩进选择或插入点所在的行， 在 Firefox 中, 如果选择多行，但是这些行存在不同级别的缩进, 只有缩进最少的行被缩进。</p>
<h4 id="3-20-insertBrOnReturn"><a href="#3-20-insertBrOnReturn" class="headerlink" title="3.20 insertBrOnReturn"></a>3.20 insertBrOnReturn</h4><p>控制当按下Enter键时，是插入 br 标签还是把当前块元素变成两个。(IE浏览器不支持)</p>
<h4 id="3-21-insertHorizontalRule"><a href="#3-21-insertHorizontalRule" class="headerlink" title="3.21 insertHorizontalRule"></a>3.21 insertHorizontalRule</h4><p>在插入点插入一个水平线（删除选中的部分）</p>
<h4 id="3-22-insertHTML"><a href="#3-22-insertHTML" class="headerlink" title="3.22 insertHTML"></a>3.22 insertHTML</h4><p>在插入点插入一个HTML字符串（删除选中的部分）。需要一个个HTML字符串作为参数。(IE浏览器不支持)</p>
<h4 id="3-23-insertImage"><a href="#3-23-insertImage" class="headerlink" title="3.23 insertImage"></a>3.23 insertImage</h4><p>在插入点插入一张图片（删除选中的部分）。需要一个image SRC URI作为参数。这个URI至少包含一个字符。空白字符也可以（IE会创建一个链接其值为null）</p>
<h4 id="3-24-insertOrderedList"><a href="#3-24-insertOrderedList" class="headerlink" title="3.24 insertOrderedList"></a>3.24 insertOrderedList</h4><p>在插入点或者选中文字上创建一个有序列表</p>
<h4 id="3-25-insertUnorderedList"><a href="#3-25-insertUnorderedList" class="headerlink" title="3.25 insertUnorderedList"></a>3.25 insertUnorderedList</h4><p>在插入点或者选中文字上创建一个无序列表。</p>
<h4 id="3-26-insertParagraph"><a href="#3-26-insertParagraph" class="headerlink" title="3.26 insertParagraph"></a>3.26 insertParagraph</h4><p>在选择或当前行周围插入一个段落。(IE会在插入点插入一个段落并删除选中的部分.)</p>
<h4 id="3-27-insertText"><a href="#3-27-insertText" class="headerlink" title="3.27 insertText"></a>3.27 insertText</h4><p>在光标插入位置插入文本内容或者覆盖所选的文本内容。</p>
<h4 id="3-28-italic"><a href="#3-28-italic" class="headerlink" title="3.28 italic"></a>3.28 italic</h4><p>在光标插入点开启或关闭斜体字。 (Internet Explorer 使用 EM 标签，而不是 I )</p>
<h4 id="3-29-justifyCenter"><a href="#3-29-justifyCenter" class="headerlink" title="3.29 justifyCenter"></a>3.29 justifyCenter</h4><p>对光标插入位置或者所选内容进行文字居中。</p>
<h4 id="3-30-justifyFull"><a href="#3-30-justifyFull" class="headerlink" title="3.30 justifyFull"></a>3.30 justifyFull</h4><p>对光标插入位置或者所选内容进行文本对齐。</p>
<h4 id="3-31-justifyLeft"><a href="#3-31-justifyLeft" class="headerlink" title="3.31 justifyLeft"></a>3.31 justifyLeft</h4><p>对光标插入位置或者所选内容进行左对齐。</p>
<h4 id="3-32-justifyRight"><a href="#3-32-justifyRight" class="headerlink" title="3.32 justifyRight"></a>3.32 justifyRight</h4><p>对光标插入位置或者所选内容进行右对齐。</p>
<h4 id="3-33-outdent"><a href="#3-33-outdent" class="headerlink" title="3.33 outdent"></a>3.33 outdent</h4><p>对光标插入行或者所选行内容减少缩进量。</p>
<h4 id="3-34-paste"><a href="#3-34-paste" class="headerlink" title="3.34 paste"></a>3.34 paste</h4><p>在光标位置粘贴剪贴板的内容，如果有被选中的内容，会被替换。</p>
<h4 id="3-35-redo"><a href="#3-35-redo" class="headerlink" title="3.35 redo"></a>3.35 redo</h4><p>重做被撤销的操作。</p>
<h4 id="3-36-removeFormat"><a href="#3-36-removeFormat" class="headerlink" title="3.36 removeFormat"></a>3.36 removeFormat</h4><p>对所选内容去除所有格式</p>
<h4 id="3-37-selectAll"><a href="#3-37-selectAll" class="headerlink" title="3.37 selectAll"></a>3.37 selectAll</h4><p>选中编辑区里的全部内容。</p>
<h4 id="3-38-strikeThrough"><a href="#3-38-strikeThrough" class="headerlink" title="3.38 strikeThrough"></a>3.38 strikeThrough</h4><p>在光标插入点开启或关闭删除线。</p>
<h4 id="3-39-subscript"><a href="#3-39-subscript" class="headerlink" title="3.39 subscript"></a>3.39 subscript</h4><p>在光标插入点开启或关闭下角标。</p>
<h4 id="3-40-superscript"><a href="#3-40-superscript" class="headerlink" title="3.40 superscript"></a>3.40 superscript</h4><p>在光标插入点开启或关闭上角标。</p>
<h4 id="3-41-underline"><a href="#3-41-underline" class="headerlink" title="3.41 underline"></a>3.41 underline</h4><p>在光标插入点开启或关闭下划线。</p>
<h4 id="3-42-undo"><a href="#3-42-undo" class="headerlink" title="3.42 undo"></a>3.42 undo</h4><p>撤销最近执行的命令。</p>
<h4 id="3-43-unlink"><a href="#3-43-unlink" class="headerlink" title="3.43 unlink"></a>3.43 unlink</h4><p>去除所选的锚链接的 <code>&lt;a&gt;</code> 标签</p>
<h4 id="3-44-useCSS"><a href="#3-44-useCSS" class="headerlink" title="3.44 useCSS"></a>3.44 useCSS</h4><p>切换使用 <code>HTML tags</code> 还是 <code>CSS</code> 来生成标记. 要求一个布尔值 <code>true/false</code> 作为参数。注: 这个属性是逻辑上的倒退 (例如. use false to use CSS, true to use HTML).(IE不支持)<br>该属性已经废弃，使用         <code>styleWithCSS</code> 代替。</p>
<h4 id="3-45-styleWithCSS"><a href="#3-45-styleWithCSS" class="headerlink" title="3.45 styleWithCSS"></a>3.45 styleWithCSS</h4><p>用这个取代 useCSS 命令。 参数如预期的那样工作, <code>i.e. true modifies/generates</code> 风格的标记属性, false 生成格式化元素。</p>
<h2 id="三、实例"><a href="#三、实例" class="headerlink" title="三、实例"></a>三、实例</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&lt;head&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &lt;title&gt;Exec Command&lt;<span class="regexp">/title&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">&lt;/</span>head&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &lt;iframe id=<span class="string">'HtmlEdit'</span> style=<span class="string">"width:400px; height: 296px"</span> marginWidth=<span class="string">'2px'</span> marginHeight=<span class="string">'2px'</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    &lt;div&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        &lt;button id=<span class="string">"bold"</span>&gt;Bold&lt;<span class="regexp">/button&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        &lt;button id="copy"&gt;Copy&lt;/</span>button&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &lt;<span class="regexp">/div&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="regexp"></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">    &lt;script language="javascript"&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">    window.onload=function()&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        var editor,boldBtnEle,copyBtnEle;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        editor = document.getElementById("HtmlEdit").contentWindow;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="regexp"></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        boldBtnEle = document.getElementById('bold');</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        copyBtnEle = document.getElementById('copy');</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="regexp"></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        boldBtnEle.addEventListener('click',addBold,false);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        copyBtnEle.addEventListener('click',copy,false);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="regexp"></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        /</span><span class="regexp">/只需键入以下设定，iframe立刻变成编辑器。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        editor.document.designMode = 'On';</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        editor.document.contentEditable = true;/</span><span class="regexp">/ 设置元素为可编辑</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="regexp"></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        function copy()&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">            editor.focus();</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">            editor.document.execCommand("copy", true, null);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"><span class="regexp"></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        /</span><span class="regexp">/加粗方法一 </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        function addBold() &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">            editor.focus();</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">            /</span><span class="regexp">/所有字体特效只是使用 execComman() 就能完成。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">            editor.document.execCommand("Bold", true, null);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">        &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">    &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">    &lt;/</span>script&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">&lt;<span class="regexp">/body&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">&lt;/</span>html&gt;</span></pre></td></tr></table></figure>


<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/execCommand?" target="_blank" rel="noopener">document.execCommand</a></li>
</ul>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-03-16 </div>
			<div class="article-title"><a href="/2017/03/16/2017-03-16-雅虎前端优化-35-条军规/" >雅虎前端优化 35 条军规</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p><strong>阅读目录</strong></p>
<ul>
<li><a href="">内容部分</a></li>
<li><a href="">css 部分</a></li>
<li><a href="">js 部分</a></li>
<li><a href="">javascript&amp;&amp;css</a></li>
<li><a href="">图片</a></li>
<li><a href="">cookie</a></li>
<li><a href="">移动端 </a></li>
<li><a href="">服务器</a></li>
</ul>
<p><strong>摘要：</strong>无论是在工作中，还是在面试中，web 前端性能的优化都是很重要的，那么我们进行优化需要从哪些方面入手呢？可以遵循雅虎的前端优化 <code>34</code> 条军规，不过现在已经是 <code>35</code> 条了，所以可以说是雅虎前端优化的 <code>35</code> 条军规。已分类，挺好的，这样对于优化有一个比较清晰的方向</p>
<h2 id="一、内容部分"><a href="#一、内容部分" class="headerlink" title="一、内容部分"></a>一、内容部分</h2><h3 id="1-尽量减少-HTTP-请求数"><a href="#1-尽量减少-HTTP-请求数" class="headerlink" title="1. 尽量减少 HTTP 请求数"></a>1. 尽量减少 HTTP 请求数</h3><p>80% 的终端用户响应时间都花在了前端上，其中大部分时间都在下载页面上的各种组件：图片，样式表，脚本，Flash 等等。减少组件数必然能够减少页面提交的 HTTP 请求数。<strong>这是让页面更快的关键</strong>。</p>
<p>减少页面组件数的一种方式是简化页面设计。但有没有一种方法可以在构建复杂的页面同时加快响应时间呢？嗯，确实有鱼和熊掌兼得的办法。</p>
<h4 id="1-1-合并文件"><a href="#1-1-合并文件" class="headerlink" title="1.1 合并文件"></a>1.1 合并文件</h4><p>是通过把所有脚本放在一个文件中的方式来减少请求数的，当然，也可以合并所有的 CSS。如果各个页面的脚本和样式不一样的话，合并文件就是一项比较麻烦的工作了，但把这个作为站点发布过程的一部分确实可以提高响应时间。</p>
<h4 id="1-2-CSS-Sprites-spraits-n-鬼怪，小妖精，调皮鬼-sprite的名词复数"><a href="#1-2-CSS-Sprites-spraits-n-鬼怪，小妖精，调皮鬼-sprite的名词复数" class="headerlink" title="1.2 CSS Sprites([spraits] n.  鬼怪，小妖精，调皮鬼( sprite的名词复数 ))"></a>1.2 CSS Sprites([spraits] n.  鬼怪，小妖精，调皮鬼( sprite的名词复数 ))</h4><p>是减少图片请求数量的首选方式。把背景图片都整合到一张图片中，然后用 CSS 的 <code>background-image</code> 和 <code>background-position</code> 属性来定位要显示的部分。</p>
<h4 id="1-3-图像映射"><a href="#1-3-图像映射" class="headerlink" title="1.3 图像映射"></a>1.3 图像映射</h4><p>可以把多张图片合并成单张图片，总大小是一样的，但减少了请求数并加速了页面加载。图片映射只有在图像在页面中连续的时候才有用，比如导航条。给 <code>image map</code> 设置坐标的过程既无聊又容易出错，用 <code>image map</code> 来做导航也不容易，所以不推荐用这种方式。</p>
<h4 id="1-4-行内图片（Base64编码）"><a href="#1-4-行内图片（Base64编码）" class="headerlink" title="1.4 行内图片（Base64编码）"></a>1.4 行内图片（Base64编码）</h4><p>用<a href="http://tools.ietf.org/html/rfc2397" target="_blank" rel="noopener"><code>data:</code> URL模式</a>来把图片嵌入页面。这样会增加 HTML 文件的大小，把行内图片放在（缓存的）样式表中是个好办法，而且成功避免了页面变“重”。但目前主流浏览器并不能很好地支持行内图片。</p>
<p>减少页面的 HTTP 请求数是个起点，这是提升站点首次访问速度的重要指导原则。</p>
<h3 id="2-减少-DNS-查找"><a href="#2-减少-DNS-查找" class="headerlink" title="2. 减少 DNS 查找"></a>2. 减少 DNS 查找</h3><p>域名系统建立了 <strong>主机名</strong> 和 <strong>IP</strong> 地址间的映射，就像电话簿上人名和号码的映射一样。当你在浏览器输入 <code>http://blog.jessechiu.com</code> 的时候，浏览器就会联系 DNS 解析器返回服务器的 IP 地址。DNS 是有成本的，它需要 20 到 120 毫秒去查找给定 主机名 的 IP 地址。在 DNS 查找完成之前，浏览器无法从主机名下载任何东西。</p>
<p>DNS 查找被缓存起来更高效，由用户的 ISP（网络服务提供商）或者本地网络存在一个特殊的缓存服务器上，但还可以缓存在个人用户的计算机上。DNS 信息被保存在操作系统的 DNS cache(微软Windows上的”DNS客户端服务”)里。大多数浏览器有独立于操作系统的自己的 cache。只要浏览器在自己的 cache 里还保留着这条记录，它就不会向操作系统查询 DNS。</p>
<p>IE 默认缓存 DNS 查找 30 分钟，写在 <code>DnsCacheTimeout</code> 注册表设置中。Firefox 缓存 1 分钟，可以用<code>network.dnsCacheExpiration</code> 配置项设置。(Fasterfox 把缓存时间改成了 1 小时 P.S. Fasterfox 是 FF 的一个提速插件)</p>
<p>如果客户端的 DNS cache 是空的（包括浏览器的和操作系统的），DNS 查找数等于页面上不同的主机名数，包括页面 URL，图片，脚本文件，样式表，Flash 对象等等组件中的主机名，减少不同的主机名就可以减少 DNS 查找。</p>
<p>减少不同主机名的数量同时也减少了页面能够并行下载的组件数量，避免 DNS 查找削减了响应时间，而减少并行下载数量却增加了响应时间。我的原则是把组件分散在2到4个主机名下，这是同时减少DNS查找和允许高并发下载的折中方案。</p>
<h3 id="3-避免重定向"><a href="#3-避免重定向" class="headerlink" title="3. 避免重定向"></a>3. 避免重定向</h3><p>重定向用 301 和 302 状态码，下面是一个有 301 状态码的 HTTP 头：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">301</span> Moved Permanently</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Location: http:<span class="comment">//example.com/newuri</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">Content-Type: text/html</span></pre></td></tr></table></figure>

<p>浏览器会自动跳转到 <code>Location</code>域指明的 URL。重定向需要的所有信息都在 HTTP 头部，而响应体一般是空的。其实额外的 HTTP 头，比如 <code>Expires</code> 和 <code>Cache-Control</code> 也表示重定向。除此之外还有别的跳转方式：refresh 元标签和 JavaScript，但如果你必须得做重定向，最好用标准的 3xxHTTP 状态码，主要是为了让返回按钮能正常使用。</p>
<p>牢记重定向会拖慢用户体验，在用户和 HTML 文档之间插入重定向会延迟页面上的所有东西，页面无法渲染，组件也无法开始下载，直到 HTML 文档被送达浏览器。</p>
<p>有一种常见的极其浪费资源的重定向，而且 web 开发人员一般都意识不到这一点，就是 URL 尾部缺少一个斜线的时候。例如，跳转到 <code>http://astrology.yahoo.com/astrology</code> 会返回一个重定向到 <code>http://astrology.yahoo.com/astrology/</code> 的 301 响应（注意添在尾部的斜线）。在 Apache 中可以用 <code>Alias</code>，<code>mod_rewrite</code> 或者 <code>DirectorySlash</code> 指令来取消不必要的重定向。</p>
<p>重定向最常见的用途是把旧站点连接到新的站点，还可以连接同一站点的不同部分，针对用户的不同情况（浏览器类型，用户帐号类型等等）做一些处理。用重定向来连接两个网站是最简单的，只需要少量的额外代码。虽然在这些时候使用重定向减少了开发人员的开发复杂度，但降低了用户体验。一种替代方案是用<code>Alias</code>和<code>mod_rewrite</code>，前提是两个代码路径都在相同的服务器上。如果是因为域名变化而使用了重定向，就可以创建一条 CNAME（创建一个指向另一个域名的 DNS 记录作为别名）结合 <code>Alias</code> 或者 <code>mod_rewrite</code> 指令。</p>
<h3 id="4-让-Ajax-可缓存"><a href="#4-让-Ajax-可缓存" class="headerlink" title="4. 让 Ajax 可缓存"></a>4. 让 Ajax 可缓存</h3><p>Ajax 的一个好处是可以给用户提供即时反馈，因为它能够从后台服务器异步请求信息。然而，用了 Ajax 就无法保证用户在等待异步 JavaScript 和 XML 响应返回期间不会非常无聊。在很多应用程序中，用户能够一直等待取决于如何使用 Ajax。例如，在基于web的电子邮件客户端中，用户为了寻找符合他们搜索标准的邮件消息，将会保持对Ajax请求返回结果的关注。重要的是，要记得“异步”并不意味着“即时”。</p>
<p>要提高性能，优化这些Ajax响应至关重要。最重要的提高Ajax性能的方法就是让响应变得可缓存,下面适用于 Ajax 的其它规则：</p>
<ul>
<li><a href="https://developer.yahoo.com/performance/rules.html#gzip" target="_blank" rel="noopener">Gzip组件</a></li>
<li><a href="https://developer.yahoo.com/performance/rules.html#dns_lookups" target="_blank" rel="noopener">减少DNS查找</a></li>
<li><a href="https://developer.yahoo.com/performance/rules.html#minify" target="_blank" rel="noopener">压缩JavaScript</a></li>
<li><a href="https://developer.yahoo.com/performance/rules.html#redirects" target="_blank" rel="noopener">避免重定向</a></li>
<li><a href="https://developer.yahoo.com/performance/rules.html#etags" target="_blank" rel="noopener">配置ETags</a></li>
</ul>
<p>我们一起看看例子，一个Web 2.0的电子邮件客户端用了Ajax来下载用户的通讯录，以便实现自动完成功能。如果用户从上一次使用之后再没有修改过她的通讯录，而且Ajax响应是可缓存的，有尚未过期的Expires或者Cache-Control HTTP头，那么之前的通讯录就可以从缓存中读出。必须通知浏览器，应该继续使用之前缓存的通讯录响应，还是去请求一个新的。可以通过给通讯录的Ajax URL里添加一个表明用户通讯录最后修改时间的时间戳来实现，例如<code>&amp;t=1190241612</code>。如果通讯录从上一次下载之后再没有被修改过，时间戳不变，通讯录就将从浏览器缓存中直接读出，从而避免一次额外的HTTP往返消耗。如果用户已经修改了通讯录，时间戳也可以确保新的URL不会匹配缓存的响应，浏览器将请求新的通讯录条目。</p>
<p>即使Ajax响应是动态创建的，而且可能只适用于单用户，它们也可以被缓存，而这样会让你的Web 2.0应用更快。</p>
<h3 id="5-延迟加载组件"><a href="#5-延迟加载组件" class="headerlink" title="5. 延迟加载组件"></a>5. 延迟加载组件</h3><p>可以凑近看看页面并问自己：什么才是一开始渲染页面所必须的？其余内容都可以等会儿。</p>
<p>JavaScript是分隔onload事件之前和之后的一个理想选择。例如，如果有JavaScript代码和支持拖放以及动画的库，这些都可以先等会儿，因为拖放元素是在页面最初渲染之后的。其它可以延迟加载的部分包括隐藏内容（在某个交互动作之后才出现的内容）和折叠的图片。</p>
<p>工具可帮你减轻工作量：</p>
<ul>
<li><a href="https://developer.yahoo.com/yui/imageloader/" target="_blank" rel="noopener">YUI Image Loader</a> 可以延迟加载折叠的图片</li>
<li><a href="https://developer.yahoo.com/yui/get/" target="_blank" rel="noopener">YUI Get utility</a> 是一种引入JS和CSS的简单方法。</li>
<li><a href="http://www.yahoo.com/" target="_blank" rel="noopener">Yahoo!主页</a> 就是一个例子，可以打开Firebug的网络面板仔细看看。</li>
</ul>
<p>最好让性能目标符合其它web开发最佳实践，比如“渐进增强”。如果客户端支持JavaScript，可以提高用户体验，但必须确保页面在不支持JavaScript时也能正常工作。所以，在确定页面运行正常之后，可以用一些延迟加载脚本增强它，以支持一些拖放和动画之类的华丽效果。</p>
<h3 id="6-预加载组件"><a href="#6-预加载组件" class="headerlink" title="6. 预加载组件"></a>6. 预加载组件</h3><p>预加载可能看起来和延迟加载是相反的，但它其实有不同的目标。通过预加载组件可以充分利用浏览器空闲的时间来请求将来会用到的组件（图片，样式和脚本）。用户访问下一页的时候，大部分组件都已经在缓存里了，所以在用户看来页面会加载得更快。</p>
<p>实际应用中有以下几种预加载的类型：</p>
<ul>
<li><p>无条件预加载<br>尽快开始加载，获取一些额外的组件。google.com 就是一个 sprite 图片预加载的好例子，这个sprite 图片并不是 google.com 主页需要的，而是搜索结果页面上的内容。</p>
</li>
<li><p>条件性预加载<br>根据用户操作猜测用户将要跳转到哪里并据此预加载。在<a href="http://search.yahoo.com/" target="_blank" rel="noopener">search.yahoo.com</a>的输入框里键入内容后，可以看到那些额外组件是怎样请求加载的。</p>
</li>
<li><p>提前预加载<br>在推出新设计之前预加载。经常在重新设计之后会听到：“这个新网站不错，但比以前更慢了”，一部分原因是用户访问先前的页面都是有旧缓存的，但新的却是一种空缓存状态下的体验。** 可以通过在将要推出新设计之前预加载一些组件来减轻这种负面影响，老站可以利用浏览器空闲的时间来请求那些新站需要的图片和脚本。**</p>
</li>
</ul>
<h3 id="7-减少-DOM-元素的数量"><a href="#7-减少-DOM-元素的数量" class="headerlink" title="7. 减少 DOM 元素的数量"></a>7. 减少 DOM 元素的数量</h3><p>一个复杂的页面意味着要下载更多的字节，而且用 JavaScript 访问DOM也会更慢。举个例子，想要添加一个事件处理器的时候，循环遍历页面上的500个DOM元素和5000个DOM元素是有区别的。</p>
<p>大量的DOM元素是一种征兆——页面上有些内容无关的标记需要清理。正在用嵌套表格来布局吗？还是为了修复布局问题而添了一堆的<code>&lt;div&gt;</code>？或许应该用更好的语义化标记。</p>
<p><a href="https://developer.yahoo.com/yui/" target="_blank" rel="noopener">YUI CSS utilities</a>对布局有很大帮助：grids.css 针对整体布局，fonts.css和reset.css可以用来去除浏览器的默认格式。这是个开始清理和思考标记的好机会，例如只在语义上有意义的时候使用<code>&lt;div&gt;</code>，而不是因为它能够渲染一个新行。</p>
<p>DOM元素的数量很容易测试，只需要在Firebug的控制台里输入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.getElementsByTagName(<span class="string">'*'</span>).length</span></pre></td></tr></table></figure>

<p>那么多少DOM元素才算是太多呢？可以参考其它类似的标记良好的页面，例如: <a href="http://www.yahoo.com/" target="_blank" rel="noopener">Yahoo!主页</a>是一个相当繁忙的页面，但只有不到 700 个元素（HTML标签）。</p>
<h3 id="8-跨域分离组件"><a href="#8-跨域分离组件" class="headerlink" title="8. 跨域分离组件"></a>8. 跨域分离组件</h3><p>分离组件可以最大化并行下载，但要确保只用不超过 2-4 个域，因为存在DNS查找的代价。例如，可以把HTML和动态内容部署在<code>www.example.org</code>，而把静态组件分离到<code>static1.example.org</code>和<code>static2.example.org</code>。</p>
<h3 id="9-尽量少用-iframe"><a href="#9-尽量少用-iframe" class="headerlink" title="9. 尽量少用 iframe"></a>9. 尽量少用 iframe</h3><p>用iframe可以把一个HTML文档插入到父文档里，重要的是明白iframe是如何工作的并高效地使用它。</p>
<p><code>&lt;iframe&gt;</code>的优点：</p>
<ul>
<li>引入缓慢的第三方内容，比如标志和广告</li>
<li>安全沙箱</li>
<li>并行下载脚本</li>
</ul>
<p><code>&lt;iframe&gt;</code>的缺点：</p>
<ul>
<li>代价高昂，即使是空白的iframe</li>
<li>阻塞页面加载</li>
<li>非语义</li>
</ul>
<h3 id="10-杜绝-404"><a href="#10-杜绝-404" class="headerlink" title="10. 杜绝 404"></a>10. 杜绝 404</h3><p>HTTP请求代价高昂，完全没有必要用一个HTTP请求去获取一个无用的响应（比如404 Not Found），只会拖慢用户体验而没有任何好处。</p>
<p>有些站点用的是有帮助的404——“你的意思是xxx？”，这样做有利于用户体验，，但也浪费了服务器资源（比如数据库等等）。最糟糕的是链接到的外部JavaScript有错误而且结果是404。首先，这种下载将阻塞并行下载。其次，浏览器会试图解析404响应体，因为它是JavaScript代码，需要找出其中可用的部分。</p>
<h2 id="二、css-部分"><a href="#二、css-部分" class="headerlink" title="二、css 部分"></a>二、css 部分</h2><h3 id="11-避免使用CSS表达式"><a href="#11-避免使用CSS表达式" class="headerlink" title="11.避免使用CSS表达式"></a>11.避免使用CSS表达式</h3><p>用CSS表达式动态设置CSS属性，是一种强大又危险的方式。从IE5开始支持，但从IE8起就不推荐使用了。例如，可以用CSS表达式把背景颜色设置成按小时交替的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">background-color: expression( (<span class="keyword">new</span> <span class="built_in">Date</span>()).getHours()%<span class="number">2</span>?<span class="string">"#B8D4FF"</span>:<span class="string">"#F08A00"</span>);</span></pre></td></tr></table></figure>

<h3 id="12-选择-lt-link-gt-舍弃-import"><a href="#12-选择-lt-link-gt-舍弃-import" class="headerlink" title="12. 选择 &lt;link&gt; 舍弃 @import"></a>12. 选择 <code>&lt;link&gt;</code> 舍弃 @import</h3><p>前面提到了一个最佳实践：为了实现逐步渲染，CSS应该放在顶部。</p>
<p>在IE中用 <code>@import</code> 与在底部用 <code>&lt;link&gt;</code> 效果一样，所以最好不要用它。</p>
<h3 id="13-避免使用滤镜"><a href="#13-避免使用滤镜" class="headerlink" title="13. 避免使用滤镜"></a>13. 避免使用滤镜</h3><p>IE专有的<code>AlphaImageLoader</code>滤镜可以用来修复IE7之前的版本中半透明PNG图片的问题。在图片加载过程中，这个滤镜会阻塞渲染，卡住浏览器，还会增加内存消耗而且是被应用到每个元素的，而不是每个图片，所以会存在一大堆问题。</p>
<p>最好的方法是干脆不要用<code>AlphaImageLoader</code>，而优雅地降级到用在IE中支持性很好的 <code>PNG8</code> 图片来代替。如果非要用<code>AlphaImageLoader</code>，应该用下划线hack：<code>_filter</code>来避免影响IE7及更高版本的用户。</p>
<h3 id="14-把样式表放在顶部"><a href="#14-把样式表放在顶部" class="headerlink" title="14. 把样式表放在顶部"></a>14. 把样式表放在顶部</h3><p>在Yahoo!研究性能的时候，我们发现把样式表放到文档的HEAD部分能让页面看起来加载地更快。这是因为把样式表放在head里能让页面逐步渲染。</p>
<p>关注性能的前端工程师想让页面逐步渲染。也就是说，我们想让浏览器尽快显示已有内容，这在页面上有一大堆内容或者用户网速很慢时显得尤为重要。给用户显示反馈（比如进度指标）的重要性已经被广泛研究过，并且被<a href="http://www.useit.com/papers/responsetime.html" target="_blank" rel="noopener">记录</a>下来了。在我们的例子中，HTML页面就是进度指标！当浏览器逐渐加载页面头部，导航条，顶部logo等等内容的时候，这些都被正在等待页面加载的用户当作反馈，能够提高整体用户体验。</p>
<h2 id="三、js-部分"><a href="#三、js-部分" class="headerlink" title="三、js 部分"></a>三、js 部分</h2><h3 id="15-去除重复脚本"><a href="#15-去除重复脚本" class="headerlink" title="15. 去除重复脚本"></a>15. 去除重复脚本</h3><p>页面含有重复的脚本文件会影响性能，这可能和你想象的不一样。在对美国前10大web站点的评审中，发现只有2个站点含有重复脚本。两个主要原因增加了在单一页面中出现重复脚本的几率：团队大小和脚本数量。在这种情况下，重复脚本会创建不必要的HTTP请求，执行无用的JavaScript代码，而影响页面性能。</p>
<p>IE会产生不必要的HTTP请求，而Firefox不会。在IE中，如果一个不可缓存的外部脚本被页面引入了两次，它会在页面加载时产生两个HTTP请求。即使脚本是可缓存的，在用户重新加载页面时也会产生额外的HTTP请求。</p>
<p>除了产生没有意义的HTTP请求之外，多次对脚本求值也会浪费时间。因为无论脚本是否可缓存，在Firefox和IE中都会执行冗余的JavaScript代码。</p>
<p>避免不小心把相同脚本引入两次的一种方法就是在模版系统中实现脚本管理模块。典型的脚本引入方法就是在HTML页面中用SCRIPT标签：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"menu_1.0.17.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span></pre></td></tr></table></figure>

<h3 id="16-尽量减少-DOM-访问"><a href="#16-尽量减少-DOM-访问" class="headerlink" title="16. 尽量减少 DOM 访问"></a>16. 尽量减少 DOM 访问</h3><p>用JavaScript访问DOM元素是很慢的，所以，为了让页面反应更迅速，应该：</p>
<ul>
<li>缓存已访问过的元素的索引</li>
<li>先“离线”更新节点，再把它们添到DOM树上</li>
<li>避免用JavaScript修复布局问题</li>
</ul>
<h3 id="17-用智能的事件处理器"><a href="#17-用智能的事件处理器" class="headerlink" title="17. 用智能的事件处理器"></a>17. 用智能的事件处理器</h3><p>有时候感觉页面反映不够灵敏，是因为有太多频繁执行的事件处理器被添加到了DOM树的不同元素上，这就是推荐使用 <strong>事件委托</strong> 的原因。如果一个<code>div</code>里面有10个按钮，应该只给div容器添加一个事件处理器，而不是给每个按钮都添加一个。事件能够冒泡，所以可以捕获事件并得知哪个按钮是事件源。</p>
<h3 id="18-把脚本放在底部"><a href="#18-把脚本放在底部" class="headerlink" title="18. 把脚本放在底部"></a>18. 把脚本放在底部</h3><p>脚本会阻塞并行下载，HTTP/1.1 官方文档建议浏览器每个主机名下并行下载的组件数不要超过两个，如果图片来自多个主机名，并行下载的数量就可以超过两个。如果脚本正在下载，浏览器就不开始任何其它下载任务，即使是在不同主机名下的。</p>
<p>有时候，并不容易把脚本移动到底部。举个例子，如果脚本是用<code>document.write</code>插入到页面内容中的，就没办法再往下移了。还可能存在作用域问题，在多数情况下，这些问题都是可以解决的。</p>
<p>一个常见的建议是用推迟（deferred）脚本，有<code>DEFER</code>属性的脚本意味着不能含有 document.write，并且提示浏览器告诉他们可以继续渲染。不幸的是，Firefox不支持<code>DEFER</code>属性。在IE中，脚本可能被推迟，但不尽如人意。如果脚本可以推迟，我们就可以把它放到页面底部，页面就可以更快地载入。</p>
<h2 id="四、javascript-css"><a href="#四、javascript-css" class="headerlink" title="四、javascript, css"></a>四、javascript, css</h2><h3 id="19-把-JavaScript-和-CSS-放到外面"><a href="#19-把-JavaScript-和-CSS-放到外面" class="headerlink" title="19. 把 JavaScript 和 CSS 放到外面"></a>19. 把 JavaScript 和 CSS 放到外面</h3><p>很多性能原则都是关于如何管理外部组件的，然而，在这些顾虑出现之前你应该问一个更基础的问题：应该把JavaScript和CSS放到外部文件中还是直接写在页面里？</p>
<p>实际上，用外部文件可以让页面更快，因为JavaScript和CSS文件会被缓存在浏览器。HTML文档中的行内JavaScript和CSS在每次请求该HTML文档的时候都会重新下载。这样做减少了所需的HTTP请求数，但增加了HTML文档的大小。另一方面，如果JavaScript和CSS在外部文件中，并且已经被浏览器缓存起来了，那么我们就成功地把HTML文档变小了，而且还没有增加HTTP请求数。</p>
<h3 id="20-压缩JavaScript和CSS"><a href="#20-压缩JavaScript和CSS" class="headerlink" title="20.压缩JavaScript和CSS"></a>20.压缩JavaScript和CSS</h3><p>压缩具体来说就是从代码中去除不必要的字符以减少大小，从而提升加载速度。代码最小化就是去掉所有注释和不必要的空白字符（空格，换行和tab）。在JavaScript中这样做能够提高响应性能，因为要下载的文件变小了。两个最常用的JavaScript代码压缩工具是JSMin和YUI Compressor，YUI compressor还可以压缩CSS。</p>
<p>混淆是一种可选的源码优化措施，要比压缩更复杂，所以混淆过程也更容易产生bug。在对美国前十的网站调查中，压缩可以缩小 <strong>21%</strong>，而混淆能缩小 <strong>25%</strong>。虽然混淆的缩小程度更高，但比压缩风险更大。</p>
<p>除了压缩外部脚本和样式，行内的<code>&lt;script&gt;</code>和<code>&lt;style&gt;</code>块也可以压缩。即使启用了gzip模块，先进行压缩也能够缩小5%或者更多的大小。JavaScript和CSS的用处越来越多，所以压缩代码会有不错的效果。</p>
<h2 id="五、图片"><a href="#五、图片" class="headerlink" title="五、图片"></a>五、图片</h2><h3 id="21-优化图片"><a href="#21-优化图片" class="headerlink" title="21.优化图片"></a>21.优化图片</h3><p>尝试把 <code>GIF</code> 格式转换成 <code>PNG</code> 格式，看看是否节省空间。在所有的 <code>PNG</code> 图片上运行 <code>pngcrush</code> (pngcrush 是一个用来批量压缩 PNG 格式图片的工具,使用pngcrush大概可以减少png图像大小 40% 左右)</p>
<h3 id="22-优化-CSS-Sprite"><a href="#22-优化-CSS-Sprite" class="headerlink" title="22. 优化 CSS Sprite"></a>22. 优化 CSS Sprite</h3><ul>
<li>在Sprite图片中横向排列一般都比纵向排列的最终文件小</li>
<li>组合Sprite图片中的相似颜色可以保持低色数，最理想的是 <code>256</code> 色以下 <code>PNG8</code> 格式</li>
<li>“对移动端友好”，不要在Sprite图片中留下太大的空隙。虽然不会在很大程度上影响图片文件的大小，但这样做可以节省用户代理把图片解压成像素映射时消耗的内存。100×100的图片是1万个像素，而1000×1000的图片就是100万个像素了。</li>
</ul>
<h3 id="23-不要用-HTML-缩放图片"><a href="#23-不要用-HTML-缩放图片" class="headerlink" title="23.不要用 HTML 缩放图片"></a>23.不要用 HTML 缩放图片</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;img width=<span class="string">"100"</span> height=<span class="string">"100"</span> src=<span class="string">"mycat.jpg"</span> alt=<span class="string">"My Cat"</span> /&gt;</span></pre></td></tr></table></figure>

<p>那么图片本身（mycat.jpg）应该是100x100px的，而不是去缩小 500px x 500px 的图片。</p>
<h3 id="24-用小的可缓存的-favicon-ico（P-S-收藏夹图标）"><a href="#24-用小的可缓存的-favicon-ico（P-S-收藏夹图标）" class="headerlink" title="24. 用小的可缓存的 favicon.ico（P.S. 收藏夹图标）"></a>24. 用小的可缓存的 favicon.ico（P.S. 收藏夹图标）</h3><p>favicon.ico 是放在服务器根目录的图片，它会带来一堆麻烦，因为即便你不管它，浏览器也会自动请求它，所以最好不要给一个<code>404 Not Found</code>响应。而且只要在同一个服务器上，每次请求它时都会发送 cookie，此外这个图片还会干扰下载顺序，例如在IE中，当你在onload中请求额外组件时，将会先下载favicon。</p>
<p>所以为了缓解favicon.ico的缺点，应该确保：</p>
<ul>
<li>足够小，最好在 <code>1K</code> 以下</li>
<li>设置合适的有效期HTTP头（以后如果想换的话就不能重命名了），把有效期设置为 <strong>几个月后</strong> 一般比较安全，可以通过检查当前favicon.ico的最后修改日期来确保变更能让浏览器知道。</li>
<li><a href="http://www.imagemagick.org/" target="_blank" rel="noopener">ImageMagick</a></li>
</ul>
<h2 id="六、cookie"><a href="#六、cookie" class="headerlink" title="六、cookie"></a>六、cookie</h2><h3 id="25-给-Cookie-减肥"><a href="#25-给-Cookie-减肥" class="headerlink" title="25. 给 Cookie 减肥"></a>25. 给 Cookie 减肥</h3><p>使用 cookie 的原因有很多，比如授权和个性化。HTTP 头中 cookie 信息在 web 服务器和浏览器之间交换。重要的是保证 cookie 尽可能的小，以最小化对用户响应时间的影响。</p>
<ul>
<li>清除不必要的 cookie</li>
<li>保证 cookie 尽可能小，以最小化对用户响应时间的影响</li>
<li>注意给 cookie 设置 <strong>合适的域级别</strong>，以免影响其它子域</li>
<li>设置合适的有效期，更早的有效期或者 <code>none</code> 可以更快的删除 cookie，提高用户响应时间</li>
</ul>
<h3 id="26-把组件放在不含-cookie-的域下"><a href="#26-把组件放在不含-cookie-的域下" class="headerlink" title="26. 把组件放在不含 cookie 的域下"></a>26. 把组件放在不含 cookie 的域下</h3><p>当浏览器发送对静态图像的请求时，cookie 也会一起发送，而服务器根本不需要这些 cookie。所以它们只会造成没有意义的网络通信量，应该确保对静态组件的请求不含 cookie。可以创建一个子域，把所有的静态组件都部署在那儿。</p>
<p>如果域名是 <code>www.example.org</code>，可以把静态组件部署到 <code>static.example.org</code>。然而，如果已经在顶级域<code>example.org</code>或者 <code>www.example.org</code> 设置了cookie，那么所有对 <code>static.example.org</code> 的请求都会含有这些 cookie。这时候可以再买一个新域名，把所有的静态组件部署上去，并保持这个新域名不含cookie。Yahoo! 用的是 <code>yimg.com</code>，YouTube 是 <code>ytimg.com</code>，Amazon 是 <code>images-amazon.com</code>等等。</p>
<p>把静态组件部署在不含cookie的域下还有一个好处是有些代理可能会拒绝缓存带cookie的组件。有一点需要注意：如果不知道应该用example.org还是<a href="http://www.example.org作为主页，可以考虑一下cookie的影响。省略www的话，就只能把cookie写到`*.example.org`，所以因为性能原因最好用www子域，并且把cookie写到这个子域下。" target="_blank" rel="noopener">www.example.org作为主页，可以考虑一下cookie的影响。省略www的话，就只能把cookie写到`*.example.org`，所以因为性能原因最好用www子域，并且把cookie写到这个子域下。</a></p>
<h2 id="七、移动端"><a href="#七、移动端" class="headerlink" title="七、移动端"></a>七、移动端</h2><h3 id="27-保证所有组件都小于-25K"><a href="#27-保证所有组件都小于-25K" class="headerlink" title="27. 保证所有组件都小于 25K"></a>27. 保证所有组件都小于 <strong>25K</strong></h3><p>这个限制是因为 <code>iPhone</code> 不能缓存大于 25K 的组件，注意这里指的是未压缩的大小。这就是为什么缩减内容本身也很重要，因为单纯的 gzip 可能不够。</p>
<h3 id="28-把组件打包到一个复合文档里"><a href="#28-把组件打包到一个复合文档里" class="headerlink" title="28. 把组件打包到一个复合文档里"></a>28. 把组件打包到一个复合文档里</h3><p>把各个组件打包成一个像有附件的电子邮件一样的复合文档里，可以用一个HTTP请求获取多个组件（记住一点：HTTP请求是代价高昂的）。用这种方式的时候，要先检查用户代理是否支持（iPhone就不支持）。</p>
<h2 id="八、服务器"><a href="#八、服务器" class="headerlink" title="八、服务器"></a>八、服务器</h2><h3 id="29-Gzip-组件"><a href="#29-Gzip-组件" class="headerlink" title="29. Gzip 组件"></a>29. Gzip 组件</h3><p>前端工程师可以想办法明显地缩短通过网络传输HTTP请求和响应的时间。毫无疑问，终端用户的带宽速度，网络服务商，对等交换点的距离等等，都是开发团队所无法控制的。但还有别的能够影响响应时间的因素，压缩可以通过减少HTTP响应的大小来缩短响应时间。</p>
<p>从HTTP/1.1开始，web客户端就有了支持压缩的 <code>Accept-Encoding HTTP</code> 请求头。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Accept-Encoding: gzip, deflate</span></pre></td></tr></table></figure>

<p>如果 web 服务器看到这个请求头，它就会用客户端列出的一种方式来压缩响应。web 服务器通过 <code>Content-Encoding</code> 响应头来通知客户端。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Content-Encoding: gzip</span></pre></td></tr></table></figure>

<p>尽可能多地用 gzip 压缩能够给页面减肥，这也是提升用户体验最简单的方法。</p>
<h3 id="30-避免图片-src-属性为空"><a href="#30-避免图片-src-属性为空" class="headerlink" title="30. 避免图片 src 属性为空"></a>30. 避免图片 src 属性为空</h3><p>Image with empty string <strong>src</strong> 属性是空字符串的图片很常见，主要以两种形式出现：</p>
<ul>
<li>straight HTML  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;img src=<span class="string">''</span>&gt;</span></pre></td></tr></table></figure></li>
<li>JavaScript  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="keyword">new</span> Image();  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">img.src = <span class="string">''</span>;</span></pre></td></tr></table></figure>

</li>
</ul>
<p>这两种形式都会引起相同的问题：** 浏览器会向服务器发送另一个请求 **。</p>
<h3 id="31-配置-ETags"><a href="#31-配置-ETags" class="headerlink" title="31. 配置 ETags"></a>31. 配置 ETags</h3><p>实体标签（ETags），是服务器和浏览器用来决定浏览器缓存中组件与源服务器中的组件是否匹配的一种机制（“实体”也就是组件：图片，脚本，样式表等等）。添加ETags可以提供一种实体验证机制，比最后修改日期更加灵活。一个ETag是一个字符串，作为一个组件某一具体版本的唯一标识符。唯一的格式约束是字符串必须用引号括起来，源服务器用相应头中的<code>ETag</code>来指定组件的ETag：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK<span class="string">`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="string">Last-Modified: Tue, 12 Dec 2006 03:03:59 GMT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="string">ETag: "10c24bc-4ab-457e1c1f"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="string">Content-Length: 12195</span></span></pre></td></tr></table></figure>

<p>然后，如果浏览器必须验证一个组件，它用 <code>If-None-Match</code>请求头来把ETag传回源服务器。如果ETags匹配成功，会返回一个304状态码，这样就减少了12195个字节的响应体。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">GET /i/yahoo.gif HTTP/<span class="number">1.1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Host: us.yimg.com</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">If-Modified-Since: Tue, <span class="number">12</span> Dec <span class="number">2006</span> <span class="number">03</span>:<span class="number">03</span>:<span class="number">59</span> GMT</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">If-None-Match: <span class="string">"10c24bc-4ab-457e1c1f"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">304</span> Not Modified</span></pre></td></tr></table></figure>


<h3 id="32-对-Ajax-用-GET-请求"><a href="#32-对-Ajax-用-GET-请求" class="headerlink" title="32. 对 Ajax 用 GET 请求"></a>32. 对 Ajax 用 GET 请求</h3><p>Yahoo!邮箱团队发现使用<code>XMLHttpRequest</code>时，浏览器的POST请求是通过一个两步的过程来实现的：先发送HTTP头，在发送数据。所以最好用GET请求，它只需要发送一个TCP报文（除非cookie特别多）。IE的URL长度最大值是 <strong>2K</strong>，所以如果要发送的数据超过2K就无法使用GET了。</p>
<p>POST请求的一个有趣的副作用是实际上没有发送任何数据，就像GET请求一样。正如<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html" target="_blank" rel="noopener">HTTP说明文档</a>中描述的，GET请求是用来检索信息的。所以它的语义只是用 <code>GET</code> 请求来请求数据，而不是用来发送需要存储到服务器的数据。</p>
<h3 id="33-尽早清空缓冲区"><a href="#33-尽早清空缓冲区" class="headerlink" title="33. 尽早清空缓冲区"></a>33. 尽早清空缓冲区</h3><p>当用户请求一个页面时，服务器需要用大约200到500毫秒来组装HTML页面，在这期间，浏览器闲等着数据到达。PHP中有一个<a href="http://php.net/flush" target="_blank" rel="noopener">flush()</a>函数，允许给浏览器发送一部分已经准备完毕的HTML响应，以便浏览器可以在后台准备剩余部分的同时开始获取组件，好处主要体现在很忙的后台或者很“轻”的前端页面上（P.S. 也就是说，响应时耗主要在后台方面时最能体现优势）。</p>
<p>较理想的清空缓冲区的位置是HEAD后面，因为HTML的HEAD部分通常更容易生成，并且允许引入任何CSS和JavaScript文件，这样就可以让浏览器在后台还在处理的时候就开始并行获取组件。</p>
<p>例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;!-- css, js --&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&lt;<span class="regexp">/head&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">&lt;?php flush(); ?&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">&lt;body&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="regexp">&lt;!-- content --&gt;</span></span></pre></td></tr></table></figure>

<h3 id="34-使用CDN（内容分发网络）"><a href="#34-使用CDN（内容分发网络）" class="headerlink" title="34. 使用CDN（内容分发网络）"></a>34. 使用CDN（<strong>内容分发网络</strong>）</h3><p>用户与服务器的物理距离对响应时间也有影响。把内容部署在多个地理位置分散的服务器上能让用户更快地载入页面。但具体要怎么做呢？</p>
<p>实现内容在地理位置上分散的第一步是：不要尝试去重新设计你的web应用程序来适应分布式结构。这取决于应用程序，改变结构可能包括一些让人望而生畏的任务，比如同步会话状态和跨服务器复制数据库事务（翻译可能不准确）。缩短用户和内容之间距离的提议可能被推迟，或者根本不可能通过，就是因为这个难题。</p>
<p>记住终端用户 <strong>80%</strong> 到 <strong>90%</strong> 的响应时间都花在下载页面组件上了：图片，样式，脚本，Flash等等，这是业绩黄金法则。最好先分散静态内容，而不是一开始就重新设计应用程序结构。这不仅能够大大减少响应时间，还更容易表现出CDN 的功劳。</p>
<p>内容分发网络（CDN）是一组分散在不同地理位置的web服务器，用来给用户更高效地发送内容。典型地，选择用来发送内容的服务器是基于网络距离的衡量标准的。例如：选跳数（hop）最少的或者响应时间最快的服务器。</p>
<h3 id="35-添上-Expires-或者-Cache-Control-HTTP-头"><a href="#35-添上-Expires-或者-Cache-Control-HTTP-头" class="headerlink" title="35. 添上 Expires 或者 Cache-Control HTTP 头"></a>35. 添上 Expires 或者 Cache-Control HTTP 头</h3><p>这条规则有两个方面：</p>
<ul>
<li>对于静态组件：通过设置一个遥远的将来时间作为<code>Expires</code>来实现永不失效</li>
<li>多余动态组件：用合适的<code>Cache-Control</code> HTTP 头来让浏览器进行条件性的请求</li>
</ul>
<p>网页设计越来越丰富，这意味着页面里有更多的脚本，图片和Flash。站点的新访客可能还是不得不提交几个HTTP请求，但通过使用有效期能让组件变得可缓存，这避免了在接下来的浏览过程中不必要的HTTP请求。有效期HTTP头通常被用在图片上，但它们应该用在所有组件上，包括脚本、样式和Flash组件。</p>
<p>浏览器（和代理）用缓存来减少HTTP请求的数目和大小，让页面能够更快加载。web服务器通过有效期HTTP响应头来告诉客户端，页面的各个组件应该被缓存多久。用一个遥远的将来时间做有效期，告诉浏览器这个响应在2010年4月15日前不会改变。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Expires: Thu, <span class="number">15</span> Apr <span class="number">2010</span> <span class="number">20</span>:<span class="number">00</span>:<span class="number">00</span> GMT<span class="string">`</span></span></pre></td></tr></table></figure>

<p>如果你用的是Apache服务器，用ExpiresDefault指令来设置相对于当前日期的有效期。下面的例子设置了从请求时间起10年的有效期：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ExpiresDefault <span class="string">"access plus 10 years"</span></span></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.cnblogs.com/xianyulaodi/p/5755079.html" target="_blank" rel="noopener">雅虎前端优化的35条军规</a></li>
<li><a href="http://www.imooc.com/learn/50" target="_blank" rel="noopener">慕课网视频</a></li>
</ul>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-03-14 </div>
			<div class="article-title"><a href="/2017/03/14/2017-03-14-javascript-caller-callee/" >Caller 和 Callee 区别</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h2 id="一、Function-caller"><a href="#一、Function-caller" class="headerlink" title="一、Function.caller"></a>一、Function.caller</h2><p>返回 <strong>调用</strong> 指定函数的 <strong>函数</strong><br>如果一个函数 <code>f</code> 是在全局作用域内被调用的,则 <code>f.caller</code> 为 <code>null</code> ,相反,如果一个函数是在另外一个函数作用域内被调用的,则 <code>f.caller</code> 指向调用它的那个函数。<br>该属性的常用形式 <code>arguments.callee.caller</code> 替代了被废弃的 <a href="https://developer.mozilla.org/zh-cn/JavaScript/Reference/Functions_and_function_scope/arguments/caller" target="_blank" rel="noopener" title="zh-cn/JavaScript/Reference/Functions_and_function_scope/arguments/caller">arguments.caller</a>;</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> _caller = myFunc.caller;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   <span class="built_in">console</span>.log(<span class="string">'myFunc(): '</span> + <span class="keyword">typeof</span> _caller);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (_caller === <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">console</span>.log(<span class="string">"该函数在全局作用域内被调用!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">   &#125; <span class="keyword">else</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">console</span>.log(<span class="string">"调用我的是函数是: "</span> + _caller.toString());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testFun</span>(<span class="params"></span>)</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">	myFunc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">myFunc();<span class="comment">// 该函数在全局作用域内被调用!</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">testFun(); <span class="comment">// 调用我的是函数是: function testFun()&#123;myFunc();&#125;</span></span></pre></td></tr></table></figure>

<h2 id="二、arguments-callee"><a href="#二、arguments-callee" class="headerlink" title="二、arguments.callee"></a>二、arguments.callee</h2><p><code>arguments.callee</code> 属性包含当前正在执行的函数。<br><code>callee</code> 是 <code>arguments</code> 对象的一个属性。它可以用于引用该函数的函数体内当前正在执行的函数。这在函数的名称是未知时很有用，例如在没有名称的函数表达式 (也称为“匿名函数”)内。</p>
<ul>
<li>arguments.length: 实参个数</li>
<li>arguments.callee.length: 形参个数</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params">a,b,c</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> _callee = <span class="built_in">arguments</span>.callee;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">   <span class="built_in">console</span>.log(<span class="string">'myFunc(): _callee 类型：'</span> + <span class="keyword">typeof</span> _callee);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   <span class="built_in">console</span>.log(<span class="string">'函数体： _callee: '</span> +_callee.toString()); </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   <span class="built_in">console</span>.log(<span class="string">'实参个数: arguments.length: '</span> +　<span class="built_in">arguments</span>.length);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   <span class="built_in">console</span>.log(<span class="string">'形参个数: _callee.length: '</span> +_callee.length);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">myFunc();</span></pre></td></tr></table></figure>
<p>应用实例:</p>
<ol>
<li>精准定时器:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下面代码在匿名函数中调用自身，来确保定时器准确的以每隔 2S 调用一次</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> timer = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  alert(i++);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  timer = setTimeout(<span class="built_in">arguments</span>.callee, <span class="number">2000</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;, <span class="number">2000</span>);</span></pre></td></tr></table></figure></li>
<li>事件取消：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绑定事件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">console</span>.log(<span class="string">'add click event!!'</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">// 点击一次后解绑自己</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">document</span>.removeEventListener(<span class="string">'click'</span>,<span class="built_in">arguments</span>.callee,<span class="literal">false</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;,<span class="literal">false</span>);</span></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>警告：在严格模式下，第 5 版 ECMAScript (ES5) 禁止使用 <code>arguments.callee()</code>。当一个函数必须调用自身的时候, 避免使用 <code>arguments.callee()</code>, 通过要么给函数表达式一个名字，，要么使用一个函数声明.</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>)</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">  "use strict"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  f1.caller; </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">f1();<span class="comment">// 报错: VM848:3 Uncaught TypeError: 'caller' and 'arguments' are restricted function properties and cannot be accessed in this context.(…)</span></span></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/caller" target="_blank" rel="noopener">Function.caller</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/arguments/callee" target="_blank" rel="noopener">arguments.callee</a></p>

	
	</div>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-03-12 </div>
			<div class="article-title"><a href="/2017/03/12/2017-03-12-javascript-lib-d3/" >D3.js</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>D3.js 是一个用于网页作图、生成互动图形的 JavaScript 函数库。它提供一个d3对象，所有方法都通过这个对象调用。</p>
<blockquote>
<p><a href="https://github.com/d3/d3" target="_blank" rel="noopener">Bring data to life with SVG, Canvas and HTML</a></p>
</blockquote>
<h2 id="操作网页元素"><a href="#操作网页元素" class="headerlink" title="操作网页元素"></a>操作网页元素</h2><p>D3提供了一系列操作网页元素的方法，很类似jQuery，也是先选中某个元素（select方法），然后对其进行某种操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> body = d3.select(<span class="string">"body"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> div = body.append(<span class="string">"div"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">div.html(<span class="string">"Hello, world!"</span>);</span></pre></td></tr></table></figure>

<p>select方法用于选中一个元素，而selectAll方法用于选中一组元素。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> section = d3.selectAll(<span class="string">"section"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> div = section.append(<span class="string">"div"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">div.html(<span class="string">"Hello, world!"</span>);</span></pre></td></tr></table></figure>

<p>大部分D3的方法都返回D3对象的实例，这意味着可以采用链式写法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">d3.select(<span class="string">"body"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    .style(<span class="string">"color"</span>, <span class="string">"black"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    .style(<span class="string">"background-color"</span>, <span class="string">"white"</span>);</span></pre></td></tr></table></figure>

<p>需要注意的是append方法返回一个新对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">d3.selectAll(<span class="string">"section"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  .attr(<span class="string">"class"</span>, <span class="string">"special"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  .append(<span class="string">"div"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  .html(<span class="string">"Hello, world!"</span>);</span></pre></td></tr></table></figure>

<h2 id="生成svg元素"><a href="#生成svg元素" class="headerlink" title="生成svg元素"></a>生成svg元素</h2><p>D3作图需要svg元素，可以用JavaScript代码动态生成。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> v = d3.select(<span class="string">"#graph"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">            .append(<span class="string">"svg"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">v.attr(<span class="string">"width"</span>, <span class="number">900</span>).attr(<span class="string">"height"</span>, <span class="number">400</span>);</span></pre></td></tr></table></figure>

<h2 id="生成图形"><a href="#生成图形" class="headerlink" title="生成图形"></a>生成图形</h2><h3 id="选中对象集"><a href="#选中对象集" class="headerlink" title="选中对象集"></a>选中对象集</h3><p>selectAll方法不仅可以选中现有的网页元素，还可以选中不存在的网页元素。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">d3.select(<span class="string">".chart"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  .selectAll(<span class="string">"div"</span>);</span></pre></td></tr></table></figure>

<p>上面代码表示，selectAll方法选中了.chart元素下面所有现有和将来可能出现的div元素。</p>
<h3 id="绑定数据"><a href="#绑定数据" class="headerlink" title="绑定数据"></a>绑定数据</h3><p>data方法用于对选中的结果集绑定数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = [<span class="number">4</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">42</span>, <span class="number">12</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">d3.select(<span class="string">".chart"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  .selectAll(<span class="string">"div"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  .data(data)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">  .enter().append(<span class="string">"div"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  .style(<span class="string">"width"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> d * <span class="number">10</span> + <span class="string">"px"</span>; &#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  .text(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> d; &#125;);</span></pre></td></tr></table></figure>

<p>上面代码中，enter方法和append方法表示由于此时div元素还不存在，必须根据数据的个数将它们创造出来。style方法和text方法的参数是函数，表示函数的运行结果就是设置网页元素的值。</p>
<p>上面代码的运行结果是生成一个条状图，但是没有对条状图的长度进行控制，下面采用scale.linear方法对数据长度进行设置。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = [<span class="number">4</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">23</span>, <span class="number">42</span>, <span class="number">12</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = d3.scale.linear()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    .domain([<span class="number">0</span>, d3.max(data)])</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    .range([<span class="number">0</span>, <span class="number">420</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">d3.select(<span class="string">".chart"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  .selectAll(<span class="string">"div"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  .data(data)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  .enter().append(<span class="string">"div"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  .style(<span class="string">"width"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> x(d) + <span class="string">"px"</span>; &#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  .text(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> d; &#125;);</span></pre></td></tr></table></figure>

<h2 id="操作SVG图形"><a href="#操作SVG图形" class="headerlink" title="操作SVG图形"></a>操作SVG图形</h2><p>使用SVG图形生成条形图，首先是选中矢量图格式，然后每个数据值生成一个g元素（group），再在每个g元素内部生成一个rect元素和text元素。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> width = <span class="number">840</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    barHeight = <span class="number">20</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = d3.scale.linear()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    .domain([<span class="number">0</span>, d3.max(dataArray)])</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    .range([<span class="number">0</span>, width]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chart = d3.select(<span class="string">".bar-chart-svg"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    .attr(<span class="string">"width"</span>, width)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    .attr(<span class="string">"height"</span>, barHeight * dataArray.length);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bar = chart.selectAll(<span class="string">"g"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    .data(dataArray)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  .enter().append(<span class="string">"g"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    .attr(<span class="string">"transform"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d, i</span>) </span>&#123; <span class="keyword">return</span> <span class="string">"translate(0,"</span> + i * barHeight + <span class="string">")"</span>; &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">bar.append(<span class="string">"rect"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    .attr(<span class="string">"width"</span>, x)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    .attr(<span class="string">"height"</span>, barHeight - <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">bar.append(<span class="string">"text"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    .attr(<span class="string">"x"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> x(d) - <span class="number">3</span>; &#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    .attr(<span class="string">"y"</span>, barHeight / <span class="number">2</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    .attr(<span class="string">"dy"</span>, <span class="string">".35em"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    .text(<span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> d; &#125;);</span></pre></td></tr></table></figure>

<h2 id="加载XML文件"><a href="#加载XML文件" class="headerlink" title="加载XML文件"></a>加载XML文件</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">d3.xml(<span class="string">'example'</span>, <span class="string">'image/svg+xml'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, data</span>) </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (error) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">console</span>.log(<span class="string">'加载SVG文件出错！'</span>, error);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 处理SVG文件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li>Mike Bostock, <a href="http://bost.ocks.org/mike/bar/" target="_blank" rel="noopener">Let’s Make a Bar Chart</a></li>
<li>Dana Silver, <a href="http://danasilver.org/2013/12/31/d3-github-language-stats/" target="_blank" rel="noopener">The d3.js Bar Chart Tutorials with Github Data</a></li>
</ul>

	
	</div>
</div>

           
		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
    	<li class="prev"><a href="/page/14/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i> Prev</a></li>
  		

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/16/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/Ajax/">Ajax<span>9</span></a></li>
		
			<li><a href="/categories/AliPay/">AliPay<span>1</span></a></li>
		
			<li><a href="/categories/Android/">Android<span>16</span></a></li>
		
			<li><a href="/categories/AngularJS/">AngularJS<span>4</span></a></li>
		
			<li><a href="/categories/BackEnd/">BackEnd<span>5</span></a></li>
		
			<li><a href="/categories/Backbone/">Backbone<span>1</span></a></li>
		
			<li><a href="/categories/Bootstrap/">Bootstrap<span>2</span></a></li>
		
			<li><a href="/categories/C-C/">C/C++<span>1</span></a></li>
		
			<li><a href="/categories/Car/">Car<span>1</span></a></li>
		
			<li><a href="/categories/Css/">Css<span>9</span></a></li>
		
			<li><a href="/categories/Css3/">Css3<span>4</span></a></li>
		
			<li><a href="/categories/Database/">Database<span>7</span></a></li>
		
			<li><a href="/categories/Design/">Design<span>1</span></a></li>
		
			<li><a href="/categories/Flutter/">Flutter<span>1</span></a></li>
		
			<li><a href="/categories/Git/">Git<span>1</span></a></li>
		
			<li><a href="/categories/Golang/">Golang<span>1</span></a></li>
		
			<li><a href="/categories/Hadoop/">Hadoop<span>1</span></a></li>
		
			<li><a href="/categories/Hexo/">Hexo<span>3</span></a></li>
		
			<li><a href="/categories/Html/">Html<span>18</span></a></li>
		
			<li><a href="/categories/Java/">Java<span>17</span></a></li>
		
			<li><a href="/categories/JavaScript/">JavaScript<span>82</span></a></li>
		
			<li><a href="/categories/Linux/">Linux<span>8</span></a></li>
		
			<li><a href="/categories/NOI/">NOI<span>1</span></a></li>
		
			<li><a href="/categories/Node-js/">Node.js<span>40</span></a></li>
		
			<li><a href="/categories/Powershell/">Powershell<span>1</span></a></li>
		
			<li><a href="/categories/Python/">Python<span>5</span></a></li>
		
			<li><a href="/categories/Read/">Read<span>9</span></a></li>
		
			<li><a href="/categories/STEM/">STEM<span>2</span></a></li>
		
			<li><a href="/categories/Synology/">Synology<span>1</span></a></li>
		
			<li><a href="/categories/Testing/">Testing<span>4</span></a></li>
		
			<li><a href="/categories/Tools/">Tools<span>16</span></a></li>
		
			<li><a href="/categories/Vue-js/">Vue.js<span>10</span></a></li>
		
			<li><a href="/categories/WeChat/">WeChat<span>4</span></a></li>
		
			<li><a href="/categories/jQuery/">jQuery<span>5</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/Mocha/">Mocha<span>1</span></a></li>
		
			<li><a href="/tags/StdLib/">StdLib<span>11</span></a></li>
		
			<li><a href="/tags/Document/">Document<span>8</span></a></li>
		
			<li><a href="/tags/Library/">Library<span>7</span></a></li>
		
			<li><a href="/tags/Android/">Android<span>3</span></a></li>
		
			<li><a href="/tags/sqlite/">sqlite<span>3</span></a></li>
		
			<li><a href="/tags/Grammar/">Grammar<span>11</span></a></li>
		
			<li><a href="/tags/gradle/">gradle<span>1</span></a></li>
		
			<li><a href="/tags/MySQL/">MySQL<span>1</span></a></li>
		
			<li><a href="/tags/stem/">stem<span>1</span></a></li>
		
			<li><a href="/tags/Bom/">Bom<span>10</span></a></li>
		
			<li><a href="/tags/OOP/">OOP<span>9</span></a></li>
		
			<li><a href="/tags/Sublime/">Sublime<span>2</span></a></li>
		
			<li><a href="/tags/noi/">noi<span>1</span></a></li>
		
			<li><a href="/tags/kotlin/">kotlin<span>1</span></a></li>
		
			<li><a href="/tags/Webpack/">Webpack<span>2</span></a></li>
		
			<li><a href="/tags/Jasmine/">Jasmine<span>1</span></a></li>
		
			<li><a href="/tags/PhantomJs/">PhantomJs<span>1</span></a></li>
		
			<li><a href="/tags/Chrome/">Chrome<span>2</span></a></li>
		
			<li><a href="/tags/synology/">synology<span>1</span></a></li>
		
		
		   <li><a href="/tags">...<span>32</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2021/03/22/2021-03-22-noi-introduce/" ><i class="fa fa-file-o"></i>全国青少年信息学奥林匹克竞赛系列活动简介</a>
      </li>
    
      <li>
        <a href="/2021/02/08/2021-02-08-stem/" ><i class="fa fa-file-o"></i>STEM</a>
      </li>
    
      <li>
        <a href="/2021/01/19/2021-01-19-kotlin-starting/" ><i class="fa fa-file-o"></i>Kotlin Starting</a>
      </li>
    
      <li>
        <a href="/2021/01/15/2021-01-15-children-programming/" ><i class="fa fa-file-o"></i>Children Programming</a>
      </li>
    
      <li>
        <a href="/2020/11/30/2020-11-30-android-gradle/" ><i class="fa fa-file-o"></i>Gradle</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="https://github.com/wzpan/freemind/" title="Freemind's Github repository." target="_blank"]);">Freemind</a></li>
	
		<li><i class="fa fa-github"></i><a href="https://github.com/JesseQiu" title="My Github account." target="_blank"]);">My Github</a></li>
	
		<li><i class="fa fa-linkedin"></i><a href="https://jesseqiu.github.io/" title="My Linkin account." target="_blank"]);">My LinkedIn</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->


	</div>
  </div>

  <div class="container-narrow">
  <footer> 
<!-- 不蒜子统计 -->

    <span id="busuanzi_container_site_pv">
            本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv" style='display:none'>
            本站访客数 <span id="busuanzi_value_site_uv"> </span>人
    </span>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<span>
  &copy; 2021 JesseChiu
  
</span>

<span>
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/" target="_blank" rel="noopener">Freemind</a>.    
</span>
 </footer>
</div> <!-- container-narrow -->

  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

  
</body>

   </html>
